<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯è³‡æ–™åº«-ç¶²ç«™ç®¡ç†å¾Œå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f7fa; padding: 20px; color: #333; display: flex; justify-content: center; min-height: 100vh; box-sizing: border-box; margin: 0; }
        .container { width: 100%; max-width: 900px; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        
        h1 { margin-top: 0; color: #2c3e50; font-size: 22px; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        /* æ¨™é¡Œé€£çµæ¨£å¼ (ä»¿ç…§ YT è¡Œç‚º) */
        .title-link {
            text-decoration: none; /* å»é™¤åº•ç·š */
            color: inherit; /* è·Ÿéš¨åŸæœ¬æ–‡å­—é¡è‰² */
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: opacity 0.2s;
        }
        .title-link:hover {
            opacity: 0.8; /* æ»‘é¼ ç§»éå»ç¨å¾®è®Šé€æ˜ */
        }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; background: #f0f2f5; padding: 5px; border-radius: 8px; gap: 5px; overflow-x: auto; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; transition: 0.2s; font-size: 14px; white-space: nowrap; }
        .tab.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active[data-type="files"] { color: #2980b9; border-bottom: 2px solid #2980b9; }
        .tab.active[data-type="user"] { color: #e74c3c; border-bottom: 2px solid #e74c3c; }
        .tab.active[data-type="notify"] { color: #d35400; border-bottom: 2px solid #d35400; }

        .section { display: none; animation: fadeIn 0.3s; flex-grow: 1; }
        .section.active { display: flex; flex-direction: column; }
        
        /* æª”æ¡ˆç¸½ç®¡ */
        .manager-wrapper { display: flex; gap: 20px; min-height: 500px; border: 1px solid #eee; border-radius: 12px; padding: 10px; background: #fafafa; }
        .tree-panel { flex: 2; background: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; overflow-y: auto; position: relative; }
        .tree-panel.unsaved { border-color: #f39c12; background: #fffdf5; }
        .action-panel { flex: 1; background: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; display: flex; flex-direction: column; }
        
        @media (max-width: 768px) {
            .manager-wrapper { flex-direction: column; height: auto; }
            .tree-panel { min-height: 400px; }
            .action-panel { height: auto; }
            body { padding: 10px; }
            .container { padding: 15px; }
        }

        /* æ¨¹ç‹€ç¯€é» */
        .node { 
            padding: 6px 10px; margin: 4px 0; border-radius: 6px; 
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.2s; user-select: none; font-size: 15px; background: #fff; border: 2px solid transparent; 
        }
        .node:hover { background: #f0f7ff; border-color: #d6eaf8; }
        .node.dragging { opacity: 0.5; background: #e0f7fa; border: 2px dashed #00bcd4; }
        .node.drag-over-top { border-top: 3px solid #3498db; }
        .node.drag-over-bottom { border-bottom: 3px solid #3498db; }
        .node.drag-over-inside { background: #d4edda; border: 2px dashed #28a745; }

        .node-content { display: flex; align-items: center; flex-grow: 1; overflow: hidden; cursor: grab; }
        .node-content:active { cursor: grabbing; }
        .node.folder .node-content { font-weight: bold; color: #2c3e50; }
        .node.file .node-content { color: #666; }
        
        .caret { display: inline-block; width: 24px; text-align: center; transition: transform 0.2s; color: #999; font-size: 12px; cursor: pointer; }
        .caret.expanded { transform: rotate(90deg); }
        .caret.hidden { opacity: 0; pointer-events: none; }

        .node-icon { margin-right: 8px; width: 24px; text-align: center; flex-shrink: 0; }
        .node-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .children-container { margin-left: 20px; border-left: 1px solid #eee; display: block; padding-left: 5px; }
        .children-container.collapsed { display: none; }

        .node-menu-btn { padding: 4px 8px; color: #aaa; cursor: pointer; font-weight: bold; font-size: 18px; border-radius: 4px; transition: 0.2s; flex-shrink: 0; margin-left: 10px; }
        .node-menu-btn:hover { background: #e0e0e0; color: #333; }
        
        .add-root-btn { display: flex; align-items: center; justify-content: center; margin-top: 15px; padding: 12px; border: 2px dashed #ddd; border-radius: 8px; color: #888; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .add-root-btn:hover { border-color: #3498db; color: #3498db; background: #f0f8ff; }

        /* é€šç”¨å…ƒä»¶ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; height: 120px; resize: none; }
        
        /* æœƒå“¡åˆ—è¡¨ */
        .user-list { list-style: none; padding: 0; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; }
        .u-status { font-size: 12px; padding: 3px 10px; border-radius: 12px; margin-left: 10px; font-weight: bold; }
        .status-pending { background: #ffeaa7; color: #d35400; }
        .status-approved { background: #27ae60; color: white; }
        .status-suspended { background: #e74c3c; color: white; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; font-size: 15px; }
        .btn-save { background: #27ae60; color: white; margin-top: auto; }
        .btn-save:hover { background: #219150; }
        .btn-save.disabled { background: #ccc; cursor: default; }
        .btn-post { background-color: #e67e22; color: white; }
        .btn-clear { background-color: #95a5a6; color: white; margin-top: 10px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-action { width: auto; padding: 6px 12px; font-size: 13px; border-radius: 6px; color: white; border: none; cursor: pointer; }
        .btn-approve { background: #27ae60; }
        .btn-suspend { background: #e74c3c; }

        /* å³éµé¸å–® */
        #ctx-menu { position: fixed; background: white; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px 0; z-index: 1000; display: none; width: 180px; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 15px; color: #333; display: flex; align-items: center; }
        .ctx-item span { margin-right: 10px; width: 20px; text-align: center; }
        .ctx-item:hover { background: #f0f7ff; color: #3498db; }
        .ctx-divider { height: 1px; background: #eee; margin: 5px 0; }

        /* ç™»å…¥èˆ‡Modal */
        #login-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        #custom-modal-overlay.show { opacity: 1; }
        .modal-box { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #custom-modal-overlay.show .modal-box { transform: scale(1); }
        .modal-icon-wrapper { width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; }
        .icon-blue { background: #e3f2fd; color: #2196f3; }
        .icon-red { background: #ffebee; color: #f44336; }
        .modal-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.2s; }
        .modal-input:focus { border-color: #3498db; outline: none; }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-cancel { background: #f1f2f6; color: #7f8c8d; }
        .btn-confirm { background: #3498db; color: white; }
        .btn-confirm.danger { background: #e74c3c; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- é›»è…¦ç‰ˆå°ˆç”¨è¨­å®š --- */
        @media (min-width: 1024px) {
            .container { max-width: 95%; }
            .manager-wrapper .tree-panel { flex: 3; }
            .manager-wrapper .action-panel { flex: 1; max-width: 350px; }
        }

        /* --- è®€å–ç•«é¢ (Loading) --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f7fa; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px; height: 40px; margin-bottom: 15px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #3498db; /* è—è‰²è½‰åœˆ */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #3498db; font-weight: bold; font-size: 16px; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">è³‡æ–™è®€å–ä¸­...</div>
    </div>

    <div id="custom-modal-overlay">
        <div class="modal-box">
            <div id="modal-icon" class="modal-icon-wrapper icon-blue">âœï¸</div>
            <div id="modal-title" class="modal-title">æ¨™é¡Œ</div>
            <div id="modal-desc" class="modal-desc">èªªæ˜æ–‡å­—</div>
            <div id="modal-content"></div>
            <div class="modal-btn-group">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="modal-btn btn-confirm">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="login-panel">
        <div class="login-box">
            <h3>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="email" id="admEmail" class="login-input" placeholder="Email">
            <input type="password" id="admPass" class="login-input" placeholder="å¯†ç¢¼">
            <button class="btn" style="background:#3498db; color:white;" onclick="doLogin()">ç™»å…¥</button>
            <p id="loginMsg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container" id="main-panel" style="display:none;">
        <h1>
            <a href="https://jiachang1112.github.io/Jiachang/admin.html" class="title-link" title="https://jiachang1112.github.io/Jiachang/admin.html">
                ğŸ› ï¸ é›²ç«¯è³‡æ–™åº«
            </a>
            <div style="display:flex; align-items:center;">
                <span id="adminName" style="font-size:14px; color:#27ae60; margin-right:10px;"></span>
                <button class="btn" style="background:#34495e; color:white; width:auto; padding:6px 15px; font-size:12px;" onclick="location.reload()">ç™»å‡º</button>
            </div>
        </h1>

        <div class="tabs">
            <div class="tab active" data-type="files" onclick="switchTab('files')">ğŸ“ æª”æ¡ˆç®¡ç†</div>
            <div class="tab" data-type="user" onclick="switchTab('user')">ğŸ‘¥ æœƒå“¡å¯©æ ¸</div>
            <div class="tab" data-type="notify" onclick="switchTab('notify')">ğŸ“¢ ç™¼å¸ƒé€šçŸ¥</div>
        </div>

        <div id="sec-files" class="section active">
            <div class="manager-wrapper">
                <div class="tree-panel" id="treeRoot" oncontextmenu="openMenu(event, null)">
                    <div style="text-align:center; padding:50px; color:#999;">è®€å–ä¸­...</div>
                </div>
                <div class="action-panel">
                    <h4 style="margin-top:0;">æ“ä½œèªªæ˜</h4>
                    <p style="font-size:13px; color:#666; line-height:1.6;">
                        1. <b>æ‹–æ›³æ’åº</b>ï¼šæŒ‰ä½æª”æ¡ˆå¯æ‹–æ›³èª¿æ•´é †åºã€‚<br>
                        2. <b>æ”¾å…¥è³‡æ–™å¤¾</b>ï¼šæ‹–æ›³è‡³è³‡æ–™å¤¾ã€Œä¸­é–“ã€è®Šç¶ è‰²æ”¾å…¥ã€‚<br>
                        3. æ‰‹æ©Ÿç‰ˆè«‹ç”¨é¸å–®çš„ã€Œâ¬†ï¸ ä¸Šç§» / â¬‡ï¸ ä¸‹ç§»ã€ã€‚<br>
                        4. é»æ“Š <b style="color:#2980b9">â–¶ ç®­é ­</b> å¯æ”¶åˆ/å±•é–‹ã€‚<br>
                        5. <b>æ“ä½œå¾Œè«‹å‹™å¿…æŒ‰å„²å­˜ã€‚</b>
                    </p>
                    <div style="margin-top:auto;">
                        <div id="statusText" style="text-align:right; font-size:12px; color:#888; margin-bottom:5px;">è³‡æ–™å·²åŒæ­¥</div>
                        <button class="btn btn-save disabled" id="saveBtn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-user" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>è¨»å†Šæœƒå“¡åˆ—è¡¨</h3>
                <button onclick="loadUsers()" style="background:#eee; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; color:#555; font-weight:bold; font-size:14px;">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            <ul class="user-list" id="userList"></ul>
        </div>

        <div id="sec-notify" class="section">
            <div class="form-group">
                <label>ğŸ“¢ ç¶²ç«™å…¨åŸŸå…¬å‘Š</label>
                <textarea id="notifyText" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
            </div>
            <div class="form-group">
                <label>é è¦½ï¼š</label>
                <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; border:1px solid #ffeeba;">
                    ğŸ“¢ <span id="previewText">(ç„¡)</span>
                </div>
            </div>
            <button class="btn btn-post" onclick="postNotification()">ğŸš€ ç™¼å¸ƒå…¬å‘Š</button>
            <button class="btn btn-clear" onclick="clearNotification()">ğŸ—‘ï¸ æ¸…é™¤å…¬å‘Š</button>
        </div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('newFolder')"><span>ğŸ“</span> æ–°å¢è³‡æ–™å¤¾</div>
        <div class="ctx-item" onclick="ctxAction('newFile')"><span>ğŸ“„</span> æ–°å¢æª”æ¡ˆ/é€£çµ</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="ctxAction('moveUp')"><span>â¬†ï¸</span> ä¸Šç§»</div>
        <div class="ctx-item" onclick="ctxAction('moveDown')"><span>â¬‡ï¸</span> ä¸‹ç§»</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="ctxAction('rename')"><span>âœï¸</span> é‡æ–°å‘½å</div>
        <div class="ctx-item" onclick="ctxAction('delete')" style="color:#e74c3c;"><span>ğŸ—‘ï¸</span> åˆªé™¤</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let fileStructure = [];
        let isDirty = false;
        let activeItem = null, activeParentArray = null, activeIndex = -1;
        let draggedItem = null, draggedParentArray = null, draggedIndex = -1;

        // ğŸŸ¢ ç™»å…¥ç‹€æ…‹ç›£è½èˆ‡ Loading é‚è¼¯
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('loading-screen');
            const loginPanel = document.getElementById('login-panel');
            const mainPanel = document.getElementById('main-panel');

            if (user) {
                // å·²ç™»å…¥
                document.getElementById('adminName').innerText = user.email;
                loginPanel.style.display = 'none'; 
                // æ³¨æ„ï¼šé€™è£¡ä¸ç›´æ¥é¡¯ç¤º mainPanelï¼Œè€Œæ˜¯ç­‰è³‡æ–™è¼‰å…¥å®Œ (loadFromCloud)
                loadFromCloud(); 
                loadUsers(); 
                loadCurrentNotification();
            } else {
                // æœªç™»å…¥
                mainPanel.style.display = 'none';
                loginPanel.style.display = 'flex';
                // æœªç™»å…¥å°±ç›´æ¥é—œé–‰è½‰åœˆåœˆ
                if(loader) loader.style.display = 'none';
            }
        });

        function doLogin() {
            auth.signInWithEmailAndPassword(document.getElementById('admEmail').value, document.getElementById('admPass').value)
                .catch(e => document.getElementById('loginMsg').innerText = e.message);
        }

        // ==========================
        // ğŸŸ¢ æª”æ¡ˆç®¡ç† (å« Loading é—œé–‰é‚è¼¯)
        // ==========================
        function loadFromCloud() {
            db.collection('system').doc('files').get().then(doc => {
                if (doc.exists && doc.data().items) {
                    fileStructure = doc.data().items;
                    renderTree();
                    markSaved();
                } else {
                    document.getElementById('treeRoot').innerHTML = '<div style="text-align:center; padding:50px;">é›²ç«¯ç„¡è³‡æ–™ï¼Œè«‹å³éµæ–°å¢</div>';
                }
                
                // --- è³‡æ–™è®€å–å®Œç•¢ï¼Œé¡¯ç¤ºç•«é¢ä¸¦é—œé–‰è½‰åœˆåœˆ ---
                document.getElementById('main-panel').style.display = 'flex';
                const loader = document.getElementById('loading-screen');
                if(loader) {
                    loader.style.opacity = '0'; // æ·¡å‡ºæ•ˆæœ
                    setTimeout(() => { loader.style.display = 'none'; }, 500); 
                }

            }).catch(e => {
                console.error(e);
                // éŒ¯èª¤æ™‚ä¹Ÿè¦é¡¯ç¤ºç•«é¢ï¼Œé¿å…å¡æ­»
                document.getElementById('main-panel').style.display = 'flex';
                document.getElementById('loading-screen').style.display = 'none';
            });
        }

        function saveToCloud() {
            if (!isDirty) return;
            const btn = document.getElementById('saveBtn');
            btn.innerText = "å„²å­˜ä¸­...";
            db.collection('system').doc('files').set({ items: fileStructure }).then(() => {
                showModal('info', 'ç³»çµ±æç¤º', 'å„²å­˜æˆåŠŸï¼', [], 'icon-blue', 'âœ…', () => { closeModal(); });
                markSaved();
            }).catch(e => {
                showModal('info', 'éŒ¯èª¤', 'å„²å­˜å¤±æ•—ï¼š' + e.message, [], 'icon-red', 'âŒ', () => { closeModal(); });
                btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯";
            });
        }

        function renderTree() {
            const root = document.getElementById('treeRoot');
            root.innerHTML = '';
            if (fileStructure.length > 0) renderNodes(fileStructure, root);
            
            const addRootBtn = document.createElement('div');
            addRootBtn.className = 'add-root-btn';
            addRootBtn.innerHTML = '<span>â• æ–°å¢æ ¹ç›®éŒ„è³‡æ–™å¤¾</span>';
            addRootBtn.onclick = () => { activeItem = null; activeParentArray = fileStructure; ctxAction('newFolder'); };
            root.appendChild(addRootBtn);
        }

        function renderNodes(items, container) {
            items.forEach((item, index) => {
                const el = document.createElement('div');
                const menuBtn = `<span class="node-menu-btn" onclick="openMenu(event, this.parentElement.itemRef, this.parentElement.parentRef, ${index})">â‹®</span>`;
                el.itemRef = item; el.parentRef = items; el.indexRef = index;
                el.setAttribute('draggable', 'true');
                el.ondragstart = (e) => handleDragStart(e, item, items, index);
                el.ondragover = (e) => handleDragOver(e, el, item);
                el.ondragleave = (e) => handleDragLeave(e, el);
                el.ondrop = (e) => handleDrop(e, item, items, index);

                if (item.type === 'folder') {
                    el.className = 'node folder';
                    if (item.collapsed === undefined) item.collapsed = false; 
                    const caretClass = item.collapsed ? 'caret' : 'caret expanded';
                    el.innerHTML = `<div class="node-content"><span class="${caretClass}">â–¶</span><span class="node-icon">ğŸ“</span><span class="node-text">${item.name}</span></div> ${menuBtn}`;
                    el.oncontextmenu = (e) => { e.stopPropagation(); openMenu(e, item, items, index); };
                    const childBox = document.createElement('div');
                    childBox.className = item.collapsed ? 'children-container collapsed' : 'children-container';
                    el.querySelector('.node-content').onclick = (e) => { e.stopPropagation(); item.collapsed = !item.collapsed; renderTree(); };
                    renderNodes(item.children, childBox);
                    container.appendChild(el); container.appendChild(childBox);
                } else {
                    el.className = 'node file';
                    el.innerHTML = `<div class="node-content"><span class="caret hidden">â–¶</span><span class="node-icon">ğŸ“„</span><span class="node-text">${item.name}</span></div> ${menuBtn}`;
                    el.oncontextmenu = (e) => { e.stopPropagation(); openMenu(e, item, items, index); };
                    container.appendChild(el);
                }
            });
        }

        function handleDragStart(e, item, parentArray, index) { e.stopPropagation(); draggedItem = item; draggedParentArray = parentArray; draggedIndex = index; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragOver(e, el, targetItem) { e.preventDefault(); e.stopPropagation(); if (el.classList.contains('dragging')) return; const rect = el.getBoundingClientRect(); const relY = e.clientY - rect.top; const height = rect.height; el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-inside'); if (targetItem.type === 'folder' && relY > height * 0.25 && relY < height * 0.75) { if(!isDescendant(draggedItem, targetItem)) el.classList.add('drag-over-inside'); } else if (relY < height * 0.5) el.classList.add('drag-over-top'); else el.classList.add('drag-over-bottom'); }
        function handleDragLeave(e, el) { el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-inside'); }
        function handleDrop(e, targetItem, targetParentArray, targetIndex) { e.preventDefault(); e.stopPropagation(); const el = e.currentTarget; el.classList.remove('dragging'); if (el.classList.contains('drag-over-inside')) { if(draggedItem === targetItem) return; draggedParentArray.splice(draggedIndex, 1); targetItem.children.push(draggedItem); targetItem.collapsed = false; } else if (el.classList.contains('drag-over-top')) { executeMove(targetParentArray, targetIndex); } else if (el.classList.contains('drag-over-bottom')) { executeMove(targetParentArray, targetIndex + 1); } el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-inside'); markDirty(); renderTree(); }
        function executeMove(targetParentArray, insertIndex) { if (draggedParentArray === targetParentArray) { if (draggedIndex < insertIndex) insertIndex--; draggedParentArray.splice(draggedIndex, 1); draggedParentArray.splice(insertIndex, 0, draggedItem); } else { draggedParentArray.splice(draggedIndex, 1); targetParentArray.splice(insertIndex, 0, draggedItem); } }
        function isDescendant(parent, child) { if (parent === child) return true; if (parent.children) { for (let sub of parent.children) { if (isDescendant(sub, child)) return true; } } return false; }

        function openMenu(e, item, parentArray, index) { e.preventDefault(); e.stopPropagation(); const menu = document.getElementById('ctx-menu'); activeItem = item; activeParentArray = parentArray || fileStructure; activeIndex = index; let x = (e.type === 'click') ? e.target.getBoundingClientRect().left - 100 : e.pageX; let y = (e.type === 'click') ? e.target.getBoundingClientRect().bottom + 5 : e.pageY; if(x < 10) x = 10; menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px'; document.addEventListener('click', () => menu.style.display = 'none', { once: true }); }

        function ctxAction(action) {
            document.getElementById('ctx-menu').style.display = 'none';
            if (action === 'newFolder') showModal('input', 'æ–°å¢è³‡æ–™å¤¾', 'è«‹è¼¸å…¥åç¨±', [{id:'folderName', placeholder:'åç¨±'}], 'icon-blue', 'ğŸ“', (v) => { if (!v.folderName) return; const newItem = { type: 'folder', name: v.folderName, children: [], collapsed: false }; (activeItem && activeItem.type === 'folder' ? activeItem.children : activeParentArray).push(newItem); if(activeItem && activeItem.type === 'folder') activeItem.collapsed = false; finishAction(); });
            else if (action === 'newFile') showModal('input', 'æ–°å¢æª”æ¡ˆ', 'è«‹è¼¸å…¥', [{id:'fileName', placeholder:'åç¨±'}, {id:'filePath', placeholder:'è·¯å¾‘'}], 'icon-blue', 'ğŸ“„', (v) => { if (!v.fileName) return; let icon = v.filePath.includes('youtu') ? "ğŸ¥" : (v.filePath.match(/\.(jpg|png)$/i) ? "ğŸ–¼ï¸" : "ğŸ“„"); const newItem = { type: 'file', name: v.fileName, path: v.filePath, note: '', icon: icon }; (activeItem && activeItem.type === 'folder' ? activeItem.children : activeParentArray).push(newItem); if(activeItem && activeItem.type === 'folder') activeItem.collapsed = false; finishAction(); });
            else if (action === 'rename' && activeItem) showModal('input', 'é‡æ–°å‘½å', '', [{id:'newName', val:activeItem.name}], 'icon-blue', 'âœï¸', (v) => { if(v.newName) { activeItem.name = v.newName; finishAction(); } });
            else if (action === 'delete' && activeItem) showModal('confirm', 'ç¢ºèªåˆªé™¤', `åˆªé™¤ã€Œ${activeItem.name}ã€ï¼Ÿ`, [], 'icon-red', '!', () => { activeParentArray.splice(activeIndex, 1); finishAction(); });
            else if (action === 'moveUp' && activeIndex > 0) { const temp = activeParentArray[activeIndex]; activeParentArray[activeIndex] = activeParentArray[activeIndex - 1]; activeParentArray[activeIndex - 1] = temp; finishAction(); }
            else if (action === 'moveDown' && activeIndex < activeParentArray.length - 1) { const temp = activeParentArray[activeIndex]; activeParentArray[activeIndex] = activeParentArray[activeIndex + 1]; activeParentArray[activeIndex + 1] = temp; finishAction(); }
        }
        function finishAction() { markDirty(); renderTree(); closeModal(); }

        // Modal
        function showModal(type, title, desc, inputs, iconClass, iconText, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const content = document.getElementById('modal-content');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            document.getElementById('modal-icon').className = 'modal-icon-wrapper ' + iconClass;
            document.getElementById('modal-icon').innerText = iconText;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            content.innerHTML = '';
            if(inputs && inputs.length > 0) {
                inputs.forEach(inp => {
                    const el = document.createElement('input'); el.type = 'text'; el.className = 'modal-input'; el.id = inp.id; el.placeholder = inp.placeholder || ''; if(inp.val) el.value = inp.val; content.appendChild(el);
                });
            }
            confirmBtn.className = 'modal-btn btn-confirm ' + (iconClass === 'icon-red' ? 'danger' : '');
            confirmBtn.onclick = () => { const v={}; if(inputs) inputs.forEach(i=>v[i.id]=document.getElementById(i.id).value.trim()); callback(v); };
            overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('show'), 10);
        }
        function closeModal() { const o = document.getElementById('custom-modal-overlay'); o.classList.remove('show'); setTimeout(() => o.style.display = 'none', 300); }

        function markDirty() { isDirty = true; document.getElementById('treeRoot').classList.add('unsaved'); document.getElementById('saveBtn').classList.remove('disabled'); document.getElementById('statusText').innerText = "âš ï¸ è®Šæ›´æœªå„²å­˜"; }
        function markSaved() { isDirty = false; document.getElementById('treeRoot').classList.remove('unsaved'); document.getElementById('saveBtn').classList.add('disabled'); document.getElementById('saveBtn').innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯"; document.getElementById('statusText').innerText = "è³‡æ–™å·²åŒæ­¥"; }

        // Other Logic
        function loadUsers() { 
            const list = document.getElementById('userList');
            list.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">è®€å–ä¸­...</li>';
            db.collection("users").orderBy("createdAt", "desc").get().then(s => { 
                let h=''; 
                s.forEach(d=>{ 
                    const u=d.data(); 
                    const isApproved = u.status === 'approved';
                    const isPending = u.status === 'pending';
                    const isSuspended = u.status === 'suspended';
                    
                    let statusHtml = '';
                    if (isPending) statusHtml = '<span class="u-status status-pending">å¾…å¯©æ ¸</span>';
                    else if (isApproved) statusHtml = '<span class="u-status status-approved">å·²é€šé</span>';
                    else if (isSuspended) statusHtml = '<span class="u-status status-suspended">å·²åœç”¨</span>';

                    let actionBtn = '';
                    if (isPending) actionBtn = `<button class="btn-action btn-approve" onclick="approveUser('${d.id}')">âœ… æ ¸å‡†</button>`;
                    else if (isApproved) actionBtn = `<button class="btn-action btn-suspend" onclick="suspendUser('${d.id}')">â›” åœç”¨</button>`;
                    else if (isSuspended) actionBtn = `<button class="btn-action btn-approve" onclick="approveUser('${d.id}')">ğŸ”„ å¾©åŸ</button>`;

                    h+=`<li class="user-item">
                        <div class="user-info">
                            <div><span class="u-name">${u.name}</span> ${statusHtml}</div>
                            <small style="color:#888;">${u.email}</small>
                        </div>
                        ${actionBtn}
                    </li>`; 
                }); 
                list.innerHTML=h||'<li style="text-align:center; padding:20px;">ç„¡æœƒå“¡è³‡æ–™</li>'; 
            }).catch(err => {
                 list.innerHTML = `<li style="text-align:center; color:red;">è®€å–å¤±æ•—ï¼š${err.message}</li>`;
            });
        }

        // ğŸŸ¢ æ ¸å‡† / å¾©åŸ
        function approveUser(uid) { 
            showModal('confirm', 'ç¢ºèªæ ¸å‡†', 'ç¢ºå®šè¦æ ¸å‡†é€™ä½æœƒå“¡å—ï¼Ÿ', [], 'icon-blue', 'âœ…', () => { 
                db.collection("users").doc(uid).update({status:"approved"}).then(() => {
                    loadUsers();
                    closeModal();
                }); 
            }); 
        }

        // ğŸŸ¢ åœç”¨ (æ–°å¢çš„åŠŸèƒ½)
        function suspendUser(uid) {
            showModal('confirm', 'ç¢ºèªåœç”¨', 'ç¢ºå®šè¦åœç”¨æ­¤å¸³è™Ÿå—ï¼Ÿä½¿ç”¨è€…å°‡ç„¡æ³•ç™»å…¥ã€‚', [], 'icon-red', '!', () => {
                db.collection("users").doc(uid).update({status:"suspended"}).then(() => {
                    loadUsers();
                    closeModal();
                });
            });
        }

        function loadCurrentNotification() { db.collection("system").doc("announcement").get().then(d => { const t = (d.exists&&d.data().active)?d.data().text:""; document.getElementById("notifyText").value=t; document.getElementById("previewText").innerText=t||"(ç„¡)"; }); document.getElementById("notifyText").addEventListener("input", function(){ document.getElementById("previewText").innerText=this.value||"(ç„¡)"; }); }
        
        function postNotification() { 
            const t=document.getElementById("notifyText").value.trim(); 
            if(!t) return showModal('info', 'æç¤º', 'è«‹è¼¸å…¥å…¬å‘Šå…§å®¹', [], 'icon-red', '!', () => closeModal());
            
            db.collection("system").doc("announcement").set({text:t, active:true, timestamp:new Date()}).then(() => {
                showModal('info', 'ç³»çµ±æç¤º', 'å·²ç™¼å¸ƒ', [], 'icon-blue', 'âœ…', () => closeModal());
            }); 
        }
        
        function clearNotification() { 
            showModal('confirm', 'ç¢ºèªæ¸…é™¤', 'ç¢ºå®šè¦æ¸…é™¤ä¸¦éš±è—å…¬å‘Šå—ï¼Ÿ', [], 'icon-red', '!', () => {
                db.collection("system").doc("announcement").set({text:"", active:false}).then(()=>{ 
                    document.getElementById("notifyText").value=""; 
                    document.getElementById("previewText").innerText="(ç„¡)"; 
                    showModal('info', 'ç³»çµ±æç¤º', 'å·²æ¸…é™¤', [], 'icon-blue', 'âœ…', () => closeModal());
                }); 
            });
        }
        
        function switchTab(t) { document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); document.getElementById('sec-'+t).classList.add('active'); document.querySelector(`.tab[data-type="${t}"]`).classList.add('active'); }
    </script>
</body>
</html>
