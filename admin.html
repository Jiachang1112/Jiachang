<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²ç«™ç®¡ç†å¾Œå° - å…¨åŠŸèƒ½ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f7fa; padding: 40px 20px; color: #333; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); min-height: 80vh; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨ Header */
        h1 { margin-top: 0; color: #2c3e50; font-size: 24px; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- Tabs åˆ†é åˆ‡æ› --- */
        .tabs { display: flex; margin-bottom: 20px; background: #f0f2f5; padding: 5px; border-radius: 8px; gap: 5px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; transition: 0.2s; font-size: 15px; }
        .tab:hover { background: #eef2f7; }
        .tab.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active[data-type="files"] { color: #2980b9; border-bottom: 2px solid #2980b9; }
        .tab.active[data-type="user"] { color: #e74c3c; border-bottom: 2px solid #e74c3c; }
        .tab.active[data-type="notify"] { color: #d35400; border-bottom: 2px solid #d35400; }

        /* å…§å®¹å€å¡Šæ§åˆ¶ */
        .section { display: none; animation: fadeIn 0.3s; flex-grow: 1; }
        .section.active { display: flex; flex-direction: column; } /* ä¿®æ”¹ç‚º flex ä»¥æ”¯æ´æª”æ¡ˆç¸½ç®¡é«˜åº¦ */
        
        /* --- ğŸŸ¢ åˆ†é  1: æª”æ¡ˆç¸½ç®¡æ¨£å¼ --- */
        .manager-wrapper { display: flex; gap: 20px; height: 500px; border: 1px solid #eee; border-radius: 12px; padding: 10px; background: #fafafa; }
        
        .tree-panel { flex: 2; background: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; overflow-y: auto; }
        .tree-panel.unsaved { border-color: #f39c12; background: #fffdf5; }

        .action-panel { flex: 1; background: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; display: flex; flex-direction: column; }
        
        /* æ¨¹ç‹€ç¯€é» */
        .node { padding: 6px 10px; margin: 2px 0; border-radius: 4px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; user-select: none; font-size: 15px; }
        .node:hover { background: #f0f7ff; }
        .node.folder { font-weight: bold; color: #2c3e50; }
        .node.file { color: #666; margin-left: 10px; }
        .node-icon { margin-right: 8px; width: 20px; text-align: center; }
        .indent { margin-left: 20px; border-left: 1px solid #eee; }

        /* --- ğŸŸ¢ åˆ†é  2 & 3: é€šç”¨è¡¨å–®èˆ‡åˆ—è¡¨ --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; height: 120px; resize: none; }
        
        /* æœƒå“¡åˆ—è¡¨ */
        .user-list { list-style: none; padding: 0; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; }
        .user-info { display: flex; flex-direction: column; }
        .u-name { font-weight: bold; color: #2c3e50; }
        .u-status { font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .status-pending { background: #ffeaa7; color: #d35400; }
        .status-approved { background: #55efc4; color: #00b894; }

        /* æŒ‰éˆ•ç¾¤ */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-save { background: #27ae60; color: white; margin-top: auto; }
        .btn-save:hover { background: #219150; }
        .btn-save.disabled { background: #ccc; cursor: default; }
        .btn-post { background-color: #e67e22; color: white; }
        .btn-clear { background-color: #95a5a6; color: white; margin-top: 10px; }
        .btn-approve { background: #27ae60; color: white; padding: 6px 12px; width: auto; }
        .btn-migrate { background: #e74c3c; color: white; font-size: 12px; width: auto; padding: 5px 10px; }

        /* å³éµé¸å–® */
        #ctx-menu { position: fixed; background: white; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px 0; z-index: 1000; display: none; width: 150px; }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; }
        .ctx-item:hover { background: #f0f7ff; color: #3498db; }
        .ctx-divider { height: 1px; background: #eee; margin: 5px 0; }

        /* ç™»å…¥é®ç½© */
        #login-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-panel">
        <div class="login-box">
            <h3>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="email" id="admEmail" class="login-input" placeholder="Email">
            <input type="password" id="admPass" class="login-input" placeholder="å¯†ç¢¼">
            <button class="btn" style="background:#3498db; color:white;" onclick="doLogin()">ç™»å…¥</button>
            <p id="loginMsg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container" id="main-panel" style="display:none;">
        <h1>
            <span>ğŸ› ï¸ ç¶²ç«™ç®¡ç†å¾Œå°</span>
            <div style="display:flex; align-items:center;">
                <span id="adminName" style="font-size:14px; color:#27ae60; margin-right:10px;"></span>
                <button class="btn" style="background:#34495e; color:white; width:auto; padding:5px 15px; font-size:12px;" onclick="location.reload()">ç™»å‡º</button>
            </div>
        </h1>

        <div class="tabs">
            <div class="tab active" data-type="files" onclick="switchTab('files')">ğŸ“ æª”æ¡ˆç®¡ç† (å³éµæ“ä½œ)</div>
            <div class="tab" data-type="user" onclick="switchTab('user')">ğŸ‘¥ æœƒå“¡å¯©æ ¸</div>
            <div class="tab" data-type="notify" onclick="switchTab('notify')">ğŸ“¢ ç™¼å¸ƒé€šçŸ¥</div>
        </div>

        <div id="sec-files" class="section active">
            <div class="manager-wrapper">
                <div class="tree-panel" id="treeRoot" oncontextmenu="return false;">
                    <div style="text-align:center; padding:50px; color:#999;">è®€å–ä¸­...</div>
                </div>
                <div class="action-panel">
                    <h4 style="margin-top:0;">æ“ä½œèªªæ˜</h4>
                    <p style="font-size:13px; color:#666; line-height:1.5;">
                        1. å°è³‡æ–™å¤¾é»æ“Š <b style="color:#e74c3c">å³éµ</b> é–‹å•Ÿé¸å–®ã€‚<br>
                        2. é¸æ“‡æ–°å¢ã€é‡æ–°å‘½åæˆ–åˆªé™¤ã€‚<br>
                        3. å®Œæˆå¾Œè«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•å„²å­˜ã€‚
                    </p>
                    <button class="btn btn-migrate" onclick="migrateFromConfig()">âš ï¸ å¾ Config.js é‡ç½®åŒ¯å…¥</button>
                    
                    <div style="margin-top:auto;">
                        <div id="statusText" style="text-align:right; font-size:12px; color:#888; margin-bottom:5px;">è³‡æ–™å·²åŒæ­¥</div>
                        <button class="btn btn-save disabled" id="saveBtn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-user" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>è¨»å†Šæœƒå“¡åˆ—è¡¨</h3>
                <button class="btn" style="width:auto; background:#eee; color:#333;" onclick="loadUsers()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            <ul class="user-list" id="userList"></ul>
        </div>

        <div id="sec-notify" class="section">
            <div class="form-group">
                <label>ğŸ“¢ ç¶²ç«™å…¨åŸŸå…¬å‘Š</label>
                <textarea id="notifyText" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
            </div>
            <div class="form-group">
                <label>é è¦½ï¼š</label>
                <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; border:1px solid #ffeeba;">
                    ğŸ“¢ <span id="previewText">(ç„¡)</span>
                </div>
            </div>
            <button class="btn btn-post" onclick="postNotification()">ğŸš€ ç™¼å¸ƒå…¬å‘Š</button>
            <button class="btn btn-clear" onclick="clearNotification()">ğŸ—‘ï¸ æ¸…é™¤å…¬å‘Š</button>
        </div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('newFolder')"><span>ğŸ“</span> æ–°å¢è³‡æ–™å¤¾</div>
        <div class="ctx-item" onclick="ctxAction('newFile')"><span>ğŸ“„</span> æ–°å¢æª”æ¡ˆ/é€£çµ</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="ctxAction('rename')"><span>âœï¸</span> é‡æ–°å‘½å</div>
        <div class="ctx-item" onclick="ctxAction('delete')" style="color:#e74c3c;"><span>ğŸ—‘ï¸</span> åˆªé™¤</div>
    </div>

    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let fileStructure = [];
        let isDirty = false;
        let activeItem = null, activeParentArray = null, activeIndex = -1;

        // ç™»å…¥ç›£è½
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('main-panel').style.display = 'flex';
                document.getElementById('adminName').innerText = user.email;
                
                // é è¨­è¼‰å…¥
                loadFromCloud();
                loadUsers();
                loadCurrentNotification();
            } else {
                document.getElementById('login-panel').style.display = 'flex';
                document.getElementById('main-panel').style.display = 'none';
            }
        });

        function doLogin() {
            auth.signInWithEmailAndPassword(document.getElementById('admEmail').value, document.getElementById('admPass').value)
                .catch(e => document.getElementById('loginMsg').innerText = e.message);
        }

        // ==========================
        // ğŸŸ¢ åˆ†é  1: æª”æ¡ˆç®¡ç†é‚è¼¯
        // ==========================
        function loadFromCloud() {
            db.collection('system').doc('files').get().then(doc => {
                if (doc.exists && doc.data().items) {
                    fileStructure = doc.data().items;
                    renderTree();
                    markSaved();
                } else {
                    document.getElementById('treeRoot').innerHTML = '<div style="text-align:center; padding:50px;">é›²ç«¯ç„¡è³‡æ–™ï¼Œè«‹æŒ‰åŒ¯å…¥</div>';
                }
            }).catch(e => console.error(e));
        }

        function saveToCloud() {
            if (!isDirty) return;
            const btn = document.getElementById('saveBtn');
            btn.innerText = "å„²å­˜ä¸­...";
            db.collection('system').doc('files').set({ items: fileStructure }).then(() => {
                alert("å„²å­˜æˆåŠŸï¼");
                markSaved();
            }).catch(e => alert("å„²å­˜å¤±æ•—ï¼š" + e.message));
        }

        function migrateFromConfig() {
            if(!confirm("ç¢ºå®šè¦å¾ config.js è¦†è“‹é›²ç«¯è³‡æ–™å—ï¼Ÿ")) return;
            fileStructure = JSON.parse(JSON.stringify(CONFIG.items));
            renderTree();
            markDirty();
        }

        function renderTree() {
            const root = document.getElementById('treeRoot');
            root.innerHTML = '';
            if (fileStructure.length === 0) {
                root.innerHTML = '<div style="padding:20px; color:#999; cursor:pointer;" oncontextmenu="openMenu(event, null)">[æŒ‰å³éµæ–°å¢]</div>';
                return;
            }
            renderNodes(fileStructure, root);
        }

        function renderNodes(items, container) {
            items.forEach((item, index) => {
                const el = document.createElement('div');
                if (item.type === 'folder') {
                    el.className = 'node folder';
                    el.innerHTML = `<span class="node-icon">ğŸ“</span> ${item.name}`;
                    el.oncontextmenu = (e) => openMenu(e, item, items, index);
                    const childBox = document.createElement('div');
                    childBox.className = 'indent';
                    renderNodes(item.children, childBox);
                    container.appendChild(el);
                    container.appendChild(childBox);
                } else {
                    el.className = 'node file';
                    el.innerHTML = `<span class="node-icon">ğŸ“„</span> ${item.name}`;
                    el.oncontextmenu = (e) => openMenu(e, item, items, index);
                    container.appendChild(el);
                }
            });
        }

        // å³éµé¸å–®é‚è¼¯
        function openMenu(e, item, parentArray, index) {
            e.preventDefault();
            const menu = document.getElementById('ctx-menu');
            activeItem = item;
            activeParentArray = parentArray || fileStructure;
            activeIndex = index;
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            document.addEventListener('click', () => menu.style.display = 'none', { once: true });
        }

        function ctxAction(action) {
            document.getElementById('ctx-menu').style.display = 'none';
            markDirty();
            
            if (action === 'newFolder') {
                const name = prompt("è³‡æ–™å¤¾åç¨±ï¼š", "æ–°è³‡æ–™å¤¾");
                if (!name) return;
                const newItem = { type: 'folder', name: name, children: [] };
                (activeItem && activeItem.type === 'folder' ? activeItem.children : activeParentArray).push(newItem);
            } else if (action === 'newFile') {
                const name = prompt("æª”æ¡ˆé¡¯ç¤ºåç¨±ï¼š", "æ–°æª”æ¡ˆ");
                if (!name) return;
                const path = prompt("æª”æ¡ˆè·¯å¾‘ (file/xxx.pdf) æˆ–ç¶²å€ï¼š", "file/");
                
                let icon = "ğŸ“„";
                if(path.includes('youtu')) icon = "ğŸ¥";
                else if(path.match(/\.(jpg|png)$/i)) icon = "ğŸ–¼ï¸";
                
                const newItem = { type: 'file', name: name, path: path, note: '', icon: icon };
                (activeItem && activeItem.type === 'folder' ? activeItem.children : activeParentArray).push(newItem);
            } else if (action === 'rename' && activeItem) {
                const newName = prompt("é‡æ–°å‘½åï¼š", activeItem.name);
                if (newName) activeItem.name = newName;
            } else if (action === 'delete' && activeItem) {
                if(confirm(`åˆªé™¤ã€Œ${activeItem.name}ã€ï¼Ÿ`)) activeParentArray.splice(activeIndex, 1);
            }
            renderTree();
        }

        function markDirty() {
            isDirty = true;
            document.getElementById('treeRoot').classList.add('unsaved');
            const btn = document.getElementById('saveBtn');
            btn.classList.remove('disabled');
            btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯ (æœªå„²å­˜)";
            document.getElementById('statusText').innerText = "âš ï¸ è®Šæ›´æœªå„²å­˜";
        }
        function markSaved() {
            isDirty = false;
            document.getElementById('treeRoot').classList.remove('unsaved');
            const btn = document.getElementById('saveBtn');
            btn.classList.add('disabled');
            btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯";
            document.getElementById('statusText').innerText = "è³‡æ–™å·²åŒæ­¥";
        }

        // ==========================
        // ğŸŸ¢ åˆ†é  2: æœƒå“¡å¯©æ ¸é‚è¼¯
        // ==========================
        function loadUsers() {
            const list = document.getElementById('userList');
            list.innerHTML = '<li style="text-align:center;">è®€å–ä¸­...</li>';
            db.collection("users").orderBy("createdAt", "desc").get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const isPending = u.status === 'pending';
                    const date = u.createdAt ? new Date(u.createdAt.seconds*1000).toLocaleDateString() : '';
                    html += `<li class="user-item">
                        <div class="user-info">
                            <div><span class="u-name">${u.name}</span> <span class="u-status ${isPending?'status-pending':'status-approved'}">${isPending?'å¾…å¯©':'å·²é€š'}</span></div>
                            <small style="color:#888;">${u.email} | ${date}</small>
                        </div>
                        ${isPending ? `<button class="btn btn-approve" onclick="approveUser('${doc.id}')">æ ¸å‡†</button>` : ''}
                    </li>`;
                });
                list.innerHTML = html || '<li style="text-align:center;">ç„¡æœƒå“¡</li>';
            });
        }
        function approveUser(uid) {
            if(confirm("æ ¸å‡†æ­¤æœƒå“¡ï¼Ÿ")) db.collection("users").doc(uid).update({status:"approved"}).then(loadUsers);
        }

        // ==========================
        // ğŸŸ¢ åˆ†é  3: ç™¼å¸ƒé€šçŸ¥é‚è¼¯
        // ==========================
        function loadCurrentNotification() {
            db.collection("system").doc("announcement").get().then(doc => {
                const text = (doc.exists && doc.data().active) ? doc.data().text : "";
                document.getElementById("notifyText").value = text;
                document.getElementById("previewText").innerText = text || "(ç„¡)";
            });
            document.getElementById("notifyText").addEventListener("input", function() {
                document.getElementById("previewText").innerText = this.value || "(ç„¡)";
            });
        }
        function postNotification() {
            const text = document.getElementById("notifyText").value.trim();
            if(!text) return alert("è«‹è¼¸å…¥å…§å®¹");
            db.collection("system").doc("announcement").set({ text: text, active: true, timestamp: new Date() })
              .then(() => alert("å…¬å‘Šå·²ç™¼å¸ƒï¼"));
        }
        function clearNotification() {
            if(confirm("æ¸…é™¤å…¬å‘Šï¼Ÿ")) {
                db.collection("system").doc("announcement").set({ text: "", active: false })
                  .then(() => {
                      document.getElementById("notifyText").value = "";
                      document.getElementById("previewText").innerText = "(ç„¡)";
                      alert("å·²æ¸…é™¤");
                  });
            }
        }

        // --- åˆ†é åˆ‡æ› ---
        function switchTab(type) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('sec-' + type).classList.add('active');
            document.querySelector(`.tab[data-type="${type}"]`).classList.add('active');
        }
    </script>
</body>
</html>
