<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²ç«™å¾Œå° - ç®¡ç†ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨åŸŸèˆ‡ç‰ˆé¢ --- */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f7fa; padding: 40px 20px; color: #333; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h1 { margin-top: 0; color: #2c3e50; font-size: 24px; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- é¸é …åˆ‡æ› (Tab) --- */
        .tabs { display: flex; margin-bottom: 25px; background: #f0f2f5; padding: 5px; border-radius: 8px; gap: 5px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; transition: 0.2s; font-size: 15px; }
        .tab:hover { background: #eef2f7; }
        .tab.active { background: #fff; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active[data-type="user"] { color: #e74c3c; } /* æœƒå“¡ç®¡ç†ç‰¹åˆ¥è‰² */
        .tab.active[data-type="notify"] { color: #d35400; } /* ğŸŸ¢ æ–°å¢ï¼šé€šçŸ¥ç®¡ç†ç‰¹åˆ¥è‰² */

        /* --- å…§å®¹å€åŸŸæ§åˆ¶ --- */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        
        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        textarea { height: 100px; resize: none; font-family: inherit; }
        input:focus, textarea:focus { border-color: #3498db; outline: none; }
        .hint { font-size: 13px; color: #888; margin-top: 6px; }

        /* --- æŒ‰éˆ• --- */
        .btn { width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-gen { background-color: #3498db; }
        .btn-gen:hover { background-color: #2980b9; }
        .btn-login { background-color: #2c3e50; width: auto; padding: 8px 20px; font-size: 14px; margin-top: 0; }
        
        /* ğŸŸ¢ æ–°å¢ï¼šé€šçŸ¥ç›¸é—œæŒ‰éˆ•æ¨£å¼ */
        .btn-post { background-color: #e67e22; }
        .btn-post:hover { background-color: #d35400; }
        .btn-clear { background-color: #95a5a6; margin-top: 10px; }
        .btn-clear:hover { background-color: #7f8c8d; }
        
        /* --- çµæœå€ --- */
        .result-box { background: #282c34; padding: 20px; border-radius: 10px; position: relative; margin-top: 20px; }
        textarea#outputCode { height: 120px; background: transparent; border: none; color: #a9b7c6; font-family: monospace; }
        .btn-copy { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* --- æœƒå“¡åˆ—è¡¨æ¨£å¼ --- */
        .user-list { list-style: none; padding: 0; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .user-item:last-child { border-bottom: none; }
        .user-info { display: flex; flex-direction: column; }
        .u-name { font-weight: bold; font-size: 16px; color: #2c3e50; }
        .u-email { font-size: 14px; color: #888; }
        .u-status { font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 10px; display: inline-block; }
        .status-pending { background: #ffeaa7; color: #d35400; }
        .status-approved { background: #55efc4; color: #00b894; }
        
        .btn-approve { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-approve:hover { background: #219150; }
        .btn-approve:disabled { background: #ccc; cursor: not-allowed; }

        #login-panel { text-align: center; padding: 40px; display: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>
            <span>ğŸ› ï¸ ç¶²ç«™ç®¡ç†å¾Œå°</span>
            <button id="adminLoginBtn" class="btn btn-login" onclick="adminLogin()">ç™»å…¥ç®¡ç†å“¡</button>
            <span id="adminName" style="font-size:14px; color:#27ae60; display:none;">(å·²ç™»å…¥)</span>
        </h1>

        <div id="login-panel">
            <h3>ğŸ”’ è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ</h3>
            <p style="color:#666; margin-bottom:20px;">éœ€é©—è­‰èº«ä»½æ‰èƒ½å­˜å–æœƒå“¡è³‡æ–™åº«</p>
            <input type="email" id="admEmail" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="admPass" placeholder="å¯†ç¢¼" style="margin-bottom:10px;">
            <button class="btn btn-gen" onclick="doLogin()">ç™»å…¥</button>
            <p id="loginMsg" style="color:red; margin-top:10px;"></p>
        </div>

        <div id="main-panel" style="display:none;">
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('gen')">ğŸ“ å…§å®¹ç”¢ç”Ÿå™¨</div>
                <div class="tab" data-type="user" onclick="switchTab('user')">ğŸ‘¥ æœƒå“¡å¯©æ ¸</div>
                <div class="tab" data-type="notify" onclick="switchTab('notify')">ğŸ“¢ ç™¼å¸ƒé€šçŸ¥</div>
            </div>

            <div id="sec-gen" class="section active">
                <div class="form-group">
                    <label>é¡å‹</label>
                    <select id="genType" onchange="toggleGenFields()">
                        <option value="file">ğŸ“„ æ–°å¢æª”æ¡ˆ</option>
                        <option value="link">ğŸ”— æ–°å¢é€£çµ / YouTube</option>
                        <option value="folder">ğŸ“ æ–°å¢è³‡æ–™å¤¾</option>
                    </select>
                </div>
                <div class="form-group"><label id="nameLabel">é¡¯ç¤ºåç¨±</label><input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« è¬›ç¾©"></div>
                <div id="pathGroup" class="form-group">
                    <label id="pathLabel">è·¯å¾‘ / ç¶²å€</label>
                    <input type="text" id="itemPath" placeholder="ä¾‹å¦‚ï¼šfile/è¬›ç¾©.pdf">
                    <div class="hint">å¦‚æœæ˜¯ GitHub æª”æ¡ˆè«‹åŠ  file/ï¼Œå¦‚æœæ˜¯é€£çµè«‹è²¼å®Œæ•´ç¶²å€</div>
                </div>
                <div id="noteGroup" class="form-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="itemNote"></div>
                <button class="btn btn-gen" onclick="generateCode()">âœ¨ ç”¢ç”Ÿç¨‹å¼ç¢¼</button>
                <div class="result-box" id="resultArea" style="display:none;">
                    <button class="btn-copy" onclick="copyCode()">è¤‡è£½</button>
                    <textarea id="outputCode" readonly></textarea>
                </div>
            </div>

            <div id="sec-user" class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">è¨»å†Šæœƒå“¡åˆ—è¡¨</h3>
                    <button onclick="loadUsers()" style="background:transparent; border:1px solid #ddd; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
                <ul class="user-list" id="userList">
                    <li style="text-align:center; padding:20px; color:#999;">è¼‰å…¥ä¸­...</li>
                </ul>
            </div>

            <div id="sec-notify" class="section">
                <div class="form-group">
                    <label>ğŸ“¢ ç¶²ç«™å…¨åŸŸå…¬å‘Š</label>
                    <div class="hint">è¼¸å…¥æ–‡å­—ä¸¦é€å‡ºï¼Œæ‰€æœ‰å­¸ç”Ÿåœ¨ç¶²ç«™ä¸Šæœƒç«‹åˆ»çœ‹åˆ°é€™æ¢è¨Šæ¯ã€‚</div>
                    <textarea id="notifyText" placeholder="ä¾‹å¦‚ï¼šä¸‹é€±äºŒæ•¸å­¸å°è€ƒï¼Œè«‹å¤§å®¶æº–å‚™ã€‚"></textarea>
                </div>
                <div class="form-group">
                    <label>é è¦½æ•ˆæœï¼š</label>
                    <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; border:1px solid #ffeeba;">
                        ğŸ“¢ <span id="previewText">(ç›®å‰ç„¡å…¬å‘Š)</span>
                    </div>
                </div>
                <button class="btn btn-post" onclick="postNotification()">ğŸš€ ç™¼å¸ƒå…¬å‘Š</button>
                <button class="btn btn-clear" onclick="clearNotification()">ğŸ—‘ï¸ æ¸…é™¤å…¬å‘Š (éš±è—)</button>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ é€™æ˜¯ä½ çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ç™»å…¥ç‹€æ…‹ç›£è½ ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('main-panel').style.display = 'block';
                document.getElementById('adminLoginBtn').style.display = 'none';
                document.getElementById('adminName').style.display = 'inline';
                document.getElementById('adminName').innerText = `(${user.email})`;
                loadUsers(); // è¼‰å…¥æœƒå“¡
                loadCurrentNotification(); // ğŸŸ¢ è¼‰å…¥ç›®å‰å…¬å‘Š
            } else {
                document.getElementById('login-panel').style.display = 'block';
                document.getElementById('main-panel').style.display = 'none';
                document.getElementById('adminLoginBtn').style.display = 'block';
                document.getElementById('adminName').style.display = 'none';
            }
        });

        // --- åŠŸèƒ½ 1ï¼šç®¡ç†å“¡ç™»å…¥ ---
        function doLogin() {
            const e = document.getElementById('admEmail').value;
            const p = document.getElementById('admPass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                document.getElementById('loginMsg').innerText = "ç™»å…¥å¤±æ•—ï¼š" + err.message;
            });
        }

        // --- åŠŸèƒ½ 2ï¼šè¼‰å…¥æœƒå“¡åˆ—è¡¨ ---
        function loadUsers() {
            const list = document.getElementById('userList');
            list.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">è³‡æ–™è®€å–ä¸­...</li>';

            db.collection("users").orderBy("createdAt", "desc").get()
            .then(snapshot => {
                if (snapshot.empty) {
                    list.innerHTML = '<li style="text-align:center; padding:20px;">ç›®å‰æ²’æœ‰æœƒå“¡è³‡æ–™</li>';
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    const isPending = u.status === 'pending';
                    const dateStr = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : 'æœªçŸ¥æ™‚é–“';
                    
                    html += `
                        <li class="user-item">
                            <div class="user-info">
                                <div>
                                    <span class="u-name">${u.name || 'æœªå‘½å'}</span>
                                    <span class="u-status ${isPending ? 'status-pending' : 'status-approved'}">
                                        ${isPending ? 'å¾…å¯©æ ¸' : 'å·²æ ¸å‡†'}
                                    </span>
                                </div>
                                <span class="u-email">${u.email} | è¨»å†Šæ—¥: ${dateStr}</span>
                            </div>
                            ${isPending ? 
                                `<button class="btn-approve" onclick="approveUser('${uid}')">âœ… æ ¸å‡†</button>` : 
                                `<button class="btn-approve" disabled style="background:#eee; color:#999;">å·²é–‹é€š</button>`
                            }
                        </li>
                    `;
                });
                list.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                list.innerHTML = `<li style="text-align:center; color:red;">è®€å–å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚<br>è«‹ç¢ºèªä½ æœ‰åœ¨ Firebase Rules è¨­å®šç®¡ç†å“¡ UIDã€‚</li>`;
            });
        }

        function approveUser(uid) {
            if(!confirm("ç¢ºå®šè¦æ ¸å‡†é€™ä½æœƒå“¡å—ï¼Ÿ")) return;
            db.collection("users").doc(uid).update({ status: "approved" }).then(() => {
                alert("æ ¸å‡†æˆåŠŸï¼");
                loadUsers();
            }).catch(err => { alert("æ“ä½œå¤±æ•—ï¼š" + err.message); });
        }

        // --- ğŸŸ¢ åŠŸèƒ½ 3ï¼šå…¬å‘Šç®¡ç†ç³»çµ± ---
        
        // è¼‰å…¥ç•¶å‰å…¬å‘Š
        function loadCurrentNotification() {
            db.collection("system").doc("announcement").get().then(doc => {
                if (doc.exists && doc.data().text && doc.data().active) {
                    const text = doc.data().text;
                    document.getElementById("notifyText").value = text;
                    document.getElementById("previewText").innerText = text;
                } else {
                    document.getElementById("notifyText").value = "";
                    document.getElementById("previewText").innerText = "(ç›®å‰ç„¡å…¬å‘Š)";
                }
            });

            // ç¶å®šè¼¸å…¥æ¡†å³æ™‚é è¦½
            document.getElementById("notifyText").addEventListener("input", function() {
                document.getElementById("previewText").innerText = this.value || "(ç©ºç™½)";
            });
        }

        // ç™¼å¸ƒå…¬å‘Š
        function postNotification() {
            const text = document.getElementById("notifyText").value.trim();
            if(!text) return alert("è«‹è¼¸å…¥å…¬å‘Šå…§å®¹ï¼");
            
            db.collection("system").doc("announcement").set({
                text: text,
                timestamp: new Date(),
                active: true
            }).then(() => alert("âœ… å…¬å‘Šå·²ç™¼å¸ƒï¼å­¸ç”Ÿé¦¬ä¸Šçœ‹å¾—åˆ°ã€‚"))
              .catch(err => alert("å¤±æ•—ï¼š" + err.message));
        }

        // æ¸…é™¤å…¬å‘Š
        function clearNotification() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤ä¸¦éš±è—å…¬å‘Šå—ï¼Ÿ")) return;
            db.collection("system").doc("announcement").set({
                text: "",
                active: false
            }).then(() => {
                document.getElementById("notifyText").value = "";
                document.getElementById("previewText").innerText = "(ç›®å‰ç„¡å…¬å‘Š)";
                alert("å·²æ¸…é™¤å…¬å‘Šã€‚");
            });
        }

        // --- ä»‹é¢åˆ‡æ›èˆ‡ä»£ç¢¼ç”¢ç”Ÿå™¨é‚è¼¯ ---
        function switchTab(type) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById('sec-' + type).classList.add('active');
            
            // è™•ç† Tab æ¨£å¼
            if(type === 'user') {
                document.querySelector('.tab[data-type="user"]').classList.add('active');
            } else if (type === 'notify') {
                document.querySelector('.tab[data-type="notify"]').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[0].classList.add('active');
            }
            
            // åˆ‡æ›æ™‚é †ä¾¿é‡æ–°è¼‰å…¥è³‡æ–™
            if(type === 'user') loadUsers();
            if(type === 'notify') loadCurrentNotification();
        }

        function toggleGenFields() {
            const type = document.getElementById("genType").value;
            const pathGroup = document.getElementById("pathGroup");
            const noteGroup = document.getElementById("noteGroup");
            
            if (type === 'folder') {
                pathGroup.style.display = 'none';
                noteGroup.style.display = 'none';
            } else {
                pathGroup.style.display = 'block';
                noteGroup.style.display = 'block';
            }
        }

        function generateCode() {
            const type = document.getElementById("genType").value;
            const name = document.getElementById("itemName").value;
            const path = document.getElementById("itemPath").value;
            const note = document.getElementById("itemNote").value;

            if (!name) return alert("è«‹è¼¸å…¥åç¨±");

            let code = "";
            if (type === 'folder') {
                code = `        {
            type: "folder",
            name: "${name}",
            children: []
        },`;
            } else {
                let icon = "ğŸ“„";
                if(type === 'link') icon = path.includes("youtu") ? "ğŸ¥" : "ğŸ”—";
                else if(path.endsWith(".jpg") || path.endsWith(".png")) icon = "ğŸ–¼ï¸";
                
                code = `        {
            type: "file",
            name: "${name}",
            path: "${path}",
            note: "${note}",
            icon: "${icon}"
        },`;
            }
            document.getElementById("outputCode").value = code;
            document.getElementById("resultArea").style.display = "block";
        }

        function copyCode() {
            const copyText = document.getElementById("outputCode");
            copyText.select();
            document.execCommand("copy");
            alert("å·²è¤‡è£½ï¼");
        }
    </script>
</body>
</html>
