<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²ç«™ç®¡ç†å¾Œå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f7fa; padding: 20px; color: #333; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; margin: 0; }
        
        /* é ‚éƒ¨ */
        header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { margin: 0; font-size: 20px; color: #2c3e50; }
        
        /* ç™»å…¥é®ç½© */
        #login-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* --- ğŸŸ¢ æª”æ¡ˆç¸½ç®¡å€åŸŸ --- */
        .manager-container { display: flex; flex-grow: 1; gap: 20px; height: 100%; overflow: hidden; }
        
        /* å·¦å´ï¼šæ¨¹ç‹€çµæ§‹ */
        .tree-panel { flex: 1; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; overflow-y: auto; border: 2px solid transparent; transition: 0.2s; }
        .tree-panel.unsaved { border-color: #f39c12; } /* æœªå„²å­˜æ™‚äº®é»ƒæ¡† */

        /* æ¨¹ç‹€ç¯€é»æ¨£å¼ */
        .node { padding: 8px 10px; margin: 2px 0; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; user-select: none; }
        .node:hover { background: #f0f7ff; }
        .node.folder { font-weight: bold; color: #2c3e50; }
        .node.file { color: #666; margin-left: 20px; }
        .node-icon { margin-right: 8px; width: 24px; text-align: center; }
        .indent { margin-left: 20px; border-left: 1px solid #eee; }

        /* å³å´ï¼šæ“ä½œé¢æ¿ */
        .action-panel { width: 300px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; display: flex; flex-direction: column; }
        .panel-title { font-size: 16px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* æŒ‰éˆ•ç¾¤ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-save { background: #27ae60; color: white; margin-top: auto; } /* å„²å­˜æŒ‰éˆ•ç½®åº• */
        .btn-save:hover { background: #219150; }
        .btn-save.disabled { background: #ccc; cursor: default; }
        
        /* --- ğŸŸ¢ å³éµé¸å–® (Context Menu) --- */
        #ctx-menu { position: fixed; background: white; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 8px; padding: 5px 0; z-index: 1000; display: none; width: 150px; }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; }
        .ctx-item:hover { background: #f0f7ff; color: #3498db; }
        .ctx-item span { margin-right: 10px; }
        .ctx-divider { height: 1px; background: #eee; margin: 5px 0; }

        /* æç¤º */
        .status-bar { margin-top: 10px; font-size: 13px; color: #888; text-align: right; }
    </style>
</head>
<body>

    <div id="login-panel">
        <div class="login-box">
            <h3>ğŸ”’ ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="email" id="admEmail" placeholder="Email">
            <input type="password" id="admPass" placeholder="å¯†ç¢¼">
            <button class="btn" style="background:#3498db; color:white;" onclick="doLogin()">ç™»å…¥</button>
            <p id="loginMsg" style="color:red; font-size:12px;"></p>
        </div>
    </div>

    <header id="main-header" style="display:none;">
        <h1>ğŸ“‚ æª”æ¡ˆçµæ§‹ç®¡ç†</h1>
        <div>
            <span id="adminDisplay" style="font-size:14px; margin-right:10px;"></span>
            <button onclick="migrateFromConfig()" style="font-size:12px; padding:5px 10px; background:#e67e22; color:white; border:none; border-radius:4px; cursor:pointer;">âš ï¸ å¾ Config åŒ¯å…¥ (åƒ…ç¬¬ä¸€æ¬¡ç”¨)</button>
        </div>
    </header>

    <div class="manager-container" id="main-panel" style="display:none;">
        <div class="tree-panel" id="treeRoot" oncontextmenu="return false;">
            <div style="text-align:center; padding:50px; color:#999;">æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...</div>
        </div>

        <div class="action-panel">
            <div class="panel-title">æ“ä½œèªªæ˜</div>
            <div style="font-size:14px; color:#555; line-height:1.6; margin-bottom:20px;">
                1. å°è‘— <b>è³‡æ–™å¤¾</b> é»æ“Š <b style="color:#e74c3c">æ»‘é¼ å³éµ</b>ã€‚<br>
                2. é¸æ“‡ <b>æ–°å¢è³‡æ–™å¤¾</b> æˆ– <b>æ–°å¢æª”æ¡ˆ</b>ã€‚<br>
                3. æ“ä½œå®Œç•¢å¾Œï¼Œè¨˜å¾—æŒ‰ä¸‹æ–¹ç¶ è‰²æŒ‰éˆ•å„²å­˜ã€‚
            </div>
            
            <div class="status-bar" id="statusText">è³‡æ–™å·²åŒæ­¥</div>
            <button class="btn btn-save disabled" id="saveBtn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯</button>
        </div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('newFolder')"><span>ğŸ“</span> æ–°å¢è³‡æ–™å¤¾</div>
        <div class="ctx-item" onclick="ctxAction('newFile')"><span>ğŸ“„</span> æ–°å¢æª”æ¡ˆ/é€£çµ</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="ctxAction('rename')"><span>âœï¸</span> é‡æ–°å‘½å</div>
        <div class="ctx-item" onclick="ctxAction('delete')" style="color:#e74c3c;"><span>ğŸ—‘ï¸</span> åˆªé™¤</div>
    </div>

    <script src="config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ è²¼ä¸Šä½ çš„ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- å…¨åŸŸè®Šæ•¸ ---
        let fileStructure = []; // ç›®å‰ç·¨è¼¯ä¸­çš„çµæ§‹
        let currentTarget = null; // å³éµé»åˆ°çš„ç›®æ¨™ (è³‡æ–™ç‰©ä»¶)
        let isDirty = false; // æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´

        // --- ç™»å…¥ ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('main-header').style.display = 'flex';
                document.getElementById('main-panel').style.display = 'flex';
                document.getElementById('adminDisplay').innerText = user.email;
                loadFromCloud(); // ç™»å…¥å¾Œè¼‰å…¥è³‡æ–™
            } else {
                document.getElementById('login-panel').style.display = 'flex';
                document.getElementById('main-header').style.display = 'none';
                document.getElementById('main-panel').style.display = 'none';
            }
        });
        function doLogin() { auth.signInWithEmailAndPassword(document.getElementById('admEmail').value, document.getElementById('admPass').value).catch(e => document.getElementById('loginMsg').innerText = e.message); }

        // --- ğŸŸ¢ æ ¸å¿ƒï¼šè®€å–èˆ‡å„²å­˜ ---
        
        function loadFromCloud() {
            db.collection('system').doc('files').get().then(doc => {
                if (doc.exists && doc.data().items) {
                    fileStructure = doc.data().items;
                    renderTree();
                    markSaved();
                } else {
                    document.getElementById('treeRoot').innerHTML = '<div style="text-align:center; padding:50px;">é›²ç«¯æ˜¯ç©ºçš„ï¼Œè«‹é»æ“Šä¸Šæ–¹æ©˜è‰²æŒ‰éˆ•åŒ¯å…¥ Config</div>';
                }
            }).catch(err => alert("è®€å–å¤±æ•—ï¼š" + err.message));
        }

        function saveToCloud() {
            if(!isDirty) return;
            const btn = document.getElementById('saveBtn');
            btn.innerText = "å„²å­˜ä¸­...";
            
            db.collection('system').doc('files').set({ items: fileStructure })
                .then(() => {
                    alert("âœ… å„²å­˜æˆåŠŸï¼å‰å°ç¶²ç«™å·²åŒæ­¥æ›´æ–°ã€‚");
                    markSaved();
                })
                .catch(err => {
                    alert("âŒ å„²å­˜å¤±æ•—ï¼š" + err.message);
                    btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯";
                });
        }

        // --- æ¬å®¶åŠŸèƒ½ (ä¸€æ¬¡æ€§) ---
        function migrateFromConfig() {
            if(!confirm("é€™æœƒè¦†è“‹é›²ç«¯ä¸Šçš„æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦å¾ config.js åŒ¯å…¥å—ï¼Ÿ")) return;
            fileStructure = JSON.parse(JSON.stringify(CONFIG.items)); // æ·±æ‹·è²
            renderTree();
            markDirty();
            alert("å·²åŒ¯å…¥ï¼Œè«‹è¨˜å¾—æŒ‰ç¶ è‰²æŒ‰éˆ•å„²å­˜ï¼");
        }

        // --- ğŸŸ¢ æ¸²æŸ“æ¨¹ç‹€çµæ§‹ (éè¿´) ---
        function renderTree() {
            const root = document.getElementById('treeRoot');
            root.innerHTML = '';
            
            // å»ºç«‹ä¸€å€‹éš±å½¢çš„ã€Œæ ¹ç›®éŒ„ã€æ–¹ä¾¿æ“ä½œ
            const rootContainer = document.createElement('div');
            // å¦‚æœæ˜¯ç©ºçš„ï¼Œé¡¯ç¤ºæç¤º
            if(fileStructure.length === 0) {
                root.innerHTML = '<div style="padding:20px; color:#999; cursor:pointer;" oncontextmenu="openMenu(event, null)">[ç©ºç™½å€åŸŸ] æŒ‰å³éµæ–°å¢è³‡æ–™å¤¾...</div>';
                return;
            }
            
            renderNodes(fileStructure, root);
        }

        function renderNodes(items, container) {
            items.forEach((item, index) => {
                const el = document.createElement('div');
                
                if (item.type === 'folder') {
                    // è³‡æ–™å¤¾
                    el.className = 'node folder';
                    el.innerHTML = `<span class="node-icon">ğŸ“</span> ${item.name}`;
                    el.oncontextmenu = (e) => openMenu(e, item, items, index);
                    
                    // å­å®¹å™¨
                    const childContainer = document.createElement('div');
                    childContainer.className = 'indent';
                    renderNodes(item.children, childContainer);
                    
                    container.appendChild(el);
                    container.appendChild(childContainer);
                } else {
                    // æª”æ¡ˆ
                    el.className = 'node file';
                    el.innerHTML = `<span class="node-icon">ğŸ“„</span> ${item.name} <small style="color:#aaa; margin-left:5px;">(${item.path || 'é€£çµ'})</small>`;
                    el.oncontextmenu = (e) => openMenu(e, item, items, index);
                    container.appendChild(el);
                }
            });
        }

        // --- ğŸŸ¢ å³éµé¸å–®é‚è¼¯ ---
        let activeItem = null; // ç•¶å‰æ“ä½œçš„ç‰©ä»¶
        let activeParentArray = null; // è©²ç‰©ä»¶æ‰€åœ¨çš„é™£åˆ— (ç”¨ä¾†åˆªé™¤)
        let activeIndex = -1; // è©²ç‰©ä»¶çš„ç´¢å¼•

        function openMenu(e, item, parentArray, index) {
            e.preventDefault();
            const menu = document.getElementById('ctx-menu');
            
            // ç´€éŒ„ç•¶å‰æ“ä½œå°è±¡
            activeItem = item;
            activeParentArray = parentArray || fileStructure; // å¦‚æœæ˜¯é»ç©ºç™½è™•ï¼Œçˆ¶é™£åˆ—å°±æ˜¯æ ¹ç›®éŒ„
            activeIndex = index;

            // å®šä½é¸å–®
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';

            // é»æ“Šåˆ¥è™•é—œé–‰é¸å–®
            document.addEventListener('click', closeMenu, { once: true });
        }

        function closeMenu() { document.getElementById('ctx-menu').style.display = 'none'; }

        function ctxAction(action) {
            closeMenu();
            markDirty();

            if (action === 'newFolder') {
                const name = prompt("è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼š", "æ–°è³‡æ–™å¤¾");
                if (!name) return;
                
                const newFolder = { type: 'folder', name: name, children: [] };
                
                // å¦‚æœæ˜¯å°è‘—è³‡æ–™å¤¾é»ï¼ŒåŠ é€²å»ï¼›å¦å‰‡åŠ åœ¨åŒå±¤
                if (activeItem && activeItem.type === 'folder') {
                    activeItem.children.push(newFolder);
                } else {
                    activeParentArray.push(newFolder);
                }
            }
            
            else if (action === 'newFile') {
                const name = prompt("é¡¯ç¤ºåç¨±ï¼š", "æ–°æª”æ¡ˆ");
                if (!name) return;
                const path = prompt("æª”æ¡ˆè·¯å¾‘ (file/xxx.pdf) æˆ– ç¶²å€ï¼š", "file/");
                
                let icon = "ğŸ“„";
                if(path.includes('youtu')) icon = "ğŸ¥";
                else if(path.endsWith('jpg') || path.endsWith('png')) icon = "ğŸ–¼ï¸";

                const newFile = { type: 'file', name: name, path: path, note: '', icon: icon };
                
                if (activeItem && activeItem.type === 'folder') {
                    activeItem.children.push(newFile);
                } else {
                    activeParentArray.push(newFile);
                }
            }

            else if (action === 'rename') {
                if(!activeItem) return;
                const newName = prompt("é‡æ–°å‘½åï¼š", activeItem.name);
                if (newName) activeItem.name = newName;
            }

            else if (action === 'delete') {
                if(!activeItem) return;
                if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${activeItem.name}ã€å—ï¼Ÿ`)) return;
                activeParentArray.splice(activeIndex, 1);
            }

            renderTree();
        }

        // --- ç‹€æ…‹ç®¡ç† ---
        function markDirty() {
            isDirty = true;
            document.getElementById('treeRoot').classList.add('unsaved');
            const btn = document.getElementById('saveBtn');
            btn.classList.remove('disabled');
            btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯ (æœ‰æœªå„²å­˜ä¿®æ”¹)";
            document.getElementById('statusText').innerText = "âš ï¸ å°šæœªå„²å­˜";
        }

        function markSaved() {
            isDirty = false;
            document.getElementById('treeRoot').classList.remove('unsaved');
            const btn = document.getElementById('saveBtn');
            btn.classList.add('disabled');
            btn.innerText = "ğŸ’¾ å„²å­˜è®Šæ›´åˆ°é›²ç«¯";
            document.getElementById('statusText').innerText = "è³‡æ–™å·²åŒæ­¥";
        }

    </script>
</body>
</html>
