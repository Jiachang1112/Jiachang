<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯è³‡æ–™åº«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ğŸ¨ CSS è®Šæ•¸ç³»çµ± --- */
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #2c3e50; --text-sub: #666666; --border: #eeeeee; --accent: #3498db; --accent-hover: #2980b9; --shadow: 0 4px 20px rgba(0,0,0,0.05); --folder-bg: #f8f9fa; --announce-bg: #fff3cd; --announce-text: #856404; }
        [data-theme="dark"] { --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sub: #a0a0a0; --border: #333333; --accent: #4fa3e0; --accent-hover: #6ab0e6; --shadow: 0 4px 20px rgba(0,0,0,0.3); --folder-bg: #2d2d2d; --announce-bg: #3e3825; --announce-text: #ffca2c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); height: 100vh; transition: background 0.3s, color 0.3s; }
        .hidden { display: none !important; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--accent); font-weight: bold; font-size: 18px; transition: 0.3s; }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: var(--shadow); width: 100%; max-width: 380px; transition: 0.3s; }
        .auth-tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 25px; }
        .auth-tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: var(--text-sub); font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); margin-bottom: -2px; }
        .form-title { text-align: center; margin-bottom: 20px; color: var(--text-main); font-size: 22px; font-weight: 700; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; background: var(--bg-color); color: var(--text-main); font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--accent); outline: none; }
        button.action-btn { width: 100%; padding: 14px; background-color: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        button.action-btn:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .msg { font-size: 14px; text-align: center; margin-top: 20px; min-height: 20px; }
        .msg.error { color: #e74c3c; }
        .msg.success { color: #27ae60; }
        .container { max-width: 900px; margin: 20px auto; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; min-height: 80vh; display: flex; flex-direction: column; transition: 0.3s; }
        .header-bar { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        
        .brand { font-size: 22px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; }
        
        .brand-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            pointer-events: none;
            cursor: default;
        }
        .brand-link span:first-child { margin-right: 8px; }

        .header-tools { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .search-box { position: relative; width: 200px; }
        .search-box input { width: 100%; padding: 8px 12px 8px 35px; border-radius: 20px; border: 1px solid var(--border); font-size: 14px; height: 38px; background: var(--bg-color); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none; }
        .theme-toggle { cursor: pointer; padding: 8px; border-radius: 50%; background: var(--bg-color); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; color: var(--text-main); transition: 0.2s; }
        .theme-toggle:hover { background: var(--border); }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--bg-color); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); }
        .user-name { font-size: 14px; color: var(--text-main); font-weight: bold; }
        .logout-btn { font-size: 12px; color: #e74c3c; cursor: pointer; font-weight: bold; }
        #announcement-bar { background: var(--announce-bg); color: var(--announce-text); padding: 12px 30px; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; transition: 0.3s; }
        #announcement-bar svg { width: 18px; height: 18px; margin-right: 8px; fill: currentColor; }
        .nav-bar { background: var(--folder-bg); padding: 12px 30px; border-bottom: 1px solid var(--border); display: flex; align-items: center; font-size: 14px; color: var(--text-sub); }
        .breadcrumb { display: flex; align-items: center; flex-grow: 1; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .breadcrumb::-webkit-scrollbar { display: none; }
        .breadcrumb-item { cursor: pointer; color: var(--accent); font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-sub); opacity: 0.5; }
        .breadcrumb-current { color: var(--text-main); font-weight: bold; cursor: default; }
        .back-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; margin-right: 15px; display: flex; align-items: center; color: var(--text-main); transition: 0.2s; }
        .back-btn:hover { background: var(--border); }
        #list-root { padding: 10px 0; flex-grow: 1; overflow-y: auto; }
        
        .list-item { display: flex; align-items: center; padding: 18px 30px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; }
        .list-item:hover { background-color: var(--folder-bg); transform: translateX(5px); }
        .list-item:last-child { border-bottom: none; }
        
        /* ğŸŸ¢ æ–°å¢ï¼šç½®é ‚é …ç›®çš„æ¨£å¼ */
        .list-item.is-pinned { 
            background-color: rgba(52, 152, 219, 0.05); /* æ·¡æ·¡çš„è—è‰²èƒŒæ™¯ */
            border-left: 3px solid #3498db; /* å·¦é‚ŠåŠ ä¸€æ¢è—ç·š */
        }
        [data-theme="dark"] .list-item.is-pinned { 
            background-color: rgba(52, 152, 219, 0.15); 
        }

        .item-icon { font-size: 28px; margin-right: 20px; min-width: 40px; text-align: center; transition: 0.2s; }
        .folder-item .item-icon { color: #f39c12; }
        .file-item .item-icon[data-type="pdf"] { color: #e74c3c; } 
        .file-item .item-icon[data-type="doc"] { color: #3498db; }
        .file-item .item-icon[data-type="img"] { color: #9b59b6; }
        .file-item .item-icon[data-type="ppt"] { color: #e67e22; }
        .file-item .item-icon[data-type="video"] { color: #e056fd; }
        .item-info { flex-grow: 1; }
        .item-name { font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 4px; display: flex; align-items: center; }
        .item-name .highlight { background: #ffeaa7; color: #d35400; padding: 0 2px; border-radius: 2px; }
        .item-note { font-size: 13px; color: var(--text-sub); }
        .item-arrow { color: var(--border); font-size: 14px; opacity: 0.5; }
        .folder-item:hover .item-arrow { opacity: 1; color: var(--accent); transform: translateX(3px); transition: 0.2s; }

        /* å·¥å…·åˆ—èˆ‡æˆ‘çš„æœ€æ„›æ¨£å¼ */
        .toolbar {
            padding: 10px 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-color);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .tool-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }
        .fav-btn-view {
            margin-left: auto; 
            background: #f1c40f;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .fav-btn-view:hover { background: #f39c12; transform: translateY(-2px); }

        /* æŒ‰éˆ•ç¾¤çµ„ (æ˜Ÿæ˜Ÿèˆ‡åœ–é‡˜) */
        .action-icons {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }

        .icon-btn {
            font-size: 20px;
            cursor: pointer;
            color: #bdc3c7;
            transition: 0.2s;
            user-select: none;
        }
        .icon-btn:hover { transform: scale(1.2); }
        
        .star-icon.active { color: #f1c40f; } /* é‡‘è‰²æ˜Ÿæ˜Ÿ */
        .pin-icon.active { color: #3498db; transform: rotate(45deg); } /* è—è‰²åœ–é‡˜ */
        
        /* --- ğŸŸ¢ Modal å½ˆçª—æ¨£å¼ --- */
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        #custom-modal-overlay.show { opacity: 1; }
        .modal-box { background: white; width: 100%; max-width: 320px; padding: 30px; border-radius: 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #custom-modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-icon-wrapper { width: 70px; height: 70px; margin: 0 auto 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 32px; }
        .icon-blue { background: #e3f2fd; color: #2196f3; }
        .icon-green { background: #e8f5e9; color: #4caf50; } 
        .icon-red { background: #ffebee; color: #f44336; } 
        .icon-warning { background: #ffebee; color: #f44336; font-size: 36px; } 
        
        .modal-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin-bottom: 10px; }
        .modal-desc { font-size: 15px; color: #7f8c8d; margin-bottom: 25px; line-height: 1.5; }
        
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; background: #2c3e50; color: white; transition: 0.2s; }
        .modal-btn:hover { background: #34495e; transform: translateY(-2px); }

        .modal-btn-group { display: flex; gap: 10px; }
        .btn-cancel { background: #f1f2f6; color: #7f8c8d; flex: 1; }
        .btn-cancel:hover { background: #e2e6ea; }
        .btn-confirm-red { background: #ff4757; color: white; flex: 1; }
        .btn-confirm-red:hover { background: #e84118; }

        /* ğŸ”´ æ‰‹å‹¢æ¨£å¼ï¼šæ¢å¾©æˆæ™®é€šæ–‡å­—æ¨£å¼ (å› ç‚ºæˆ‘å€‘æ”¹ç”¨ Console è§¸ç™¼äº†) */
        .secret-hand {
            cursor: default; 
            user-select: none;
            display: inline-block;
        }

        @media (max-width: 600px) {
            .container { margin: 0; border-radius: 0; min-height: 100vh; }
            .header-bar { padding: 15px 20px; }
            .header-tools { width: 100%; justify-content: space-between; margin-top: 10px; }
            .search-box { width: 100%; flex-grow: 1; margin-right: 10px; }
            .list-item { padding: 15px 20px; }
            
            /* å·¥å…·åˆ—æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
            .toolbar { padding: 10px 20px; gap: 10px; }
            .tool-select { flex-grow: 1; }
            .fav-btn-view { width: 100%; justify-content: center; margin-left: 0; }
        }

        @media (min-width: 1024px) {
            .container { max-width: 95%; }
            .brand-link { pointer-events: auto; cursor: pointer; }
            .brand-link:hover { opacity: 0.8; }
        }

        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-mask"><div class="spinner"></div><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div id="auth-container">
        <div class="auth-box">
            <div class="auth-tabs"><div class="auth-tab active" onclick="switchMode('login')">æœƒå“¡ç™»å…¥</div><div class="auth-tab" onclick="switchMode('register')">è¨»å†Šå¸³è™Ÿ</div></div>
            <div id="login-form">
                <div class="form-title">
                    <span class="secret-hand">ğŸ‘‹</span> æ­¡è¿å›ä¾†
                </div>
                <div class="input-group"><input type="email" id="loginEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="loginPass" placeholder="å¯†ç¢¼"></div>
                <button class="action-btn" onclick="handleLogin()" id="loginBtn">ç™»å…¥ç³»çµ±</button>
            </div>
            <div id="register-form" class="hidden">
                <div class="form-title">ğŸ“ å»ºç«‹æ–°å¸³è™Ÿ</div>
                <div class="input-group"><input type="text" id="regName" placeholder="æ‚¨çš„å§“å"></div>
                <div class="input-group"><input type="email" id="regEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="regPass" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)"></div>
                <button class="action-btn" onclick="handleRegister()" id="regBtn" style="background-color:#27ae60;">æäº¤è¨»å†Šç”³è«‹</button>
            </div>
            <div id="msg-box" class="msg"></div>
        </div>
        
        </div>

    <div id="custom-modal-overlay">
        <div class="modal-box">
            </div>
    </div>

    <div id="content" class="hidden">
        <div class="container">
            <div class="header-bar">
                <div class="brand">
                    <a href="https://jiachang1112.github.io/Jiachang/index.html" class="brand-link" title="https://jiachang1112.github.io/Jiachang/index.html">
                        <span>ğŸ“‚</span> <div id="page-title">é›²ç«¯è³‡æ–™åº«</div>
                    </a>
                </div>
                <div class="header-tools">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="searchInput" placeholder="æœå°‹é—œéµå­—..." onkeyup="handleSearch()">
                    </div>
                    <div class="theme-toggle" onclick="toggleTheme()"><span id="theme-icon">ğŸŒ™</span></div>
                    <div class="user-profile"><span class="user-name" id="user-display">User</span><div class="logout-btn" onclick="showLogoutModal()">ç™»å‡º</div></div>
                </div>
            </div>

            <div id="announcement-bar" class="hidden">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                <span id="announcement-text"></span>
            </div>

            <div class="nav-bar">
                <button id="backBtn" class="back-btn hidden" onclick="goUp()">
                    <span style="margin-right:5px;">â¬…</span> è¿”å›
                </button>
                <div class="breadcrumb" id="breadcrumb-container"></div>
            </div>

            <div class="toolbar" id="toolbar">
                <select id="sortSelect" class="tool-select" onchange="refreshCurrentView()">
                    <option value="name_asc">æŒ‰åç¨± (A-Z)</option>
                    <option value="name_desc">æŒ‰åç¨± (Z-A)</option>
                    <option value="type">æŒ‰é¡å‹</option>
                </select>

                <select id="filterSelect" class="tool-select" onchange="refreshCurrentView()">
                    <option value="all">é¡¯ç¤ºå…¨éƒ¨é¡å‹</option>
                    <option value="doc">ğŸ“„ æ–‡ä»¶ (Doc/PDF)</option>
                    <option value="video">ğŸ¥ å½±ç‰‡</option>
                    <option value="img">ğŸ–¼ï¸ åœ–ç‰‡</option>
                </select>

                <button class="fav-btn-view" onclick="toggleFavoritesView()" id="favViewBtn">
                    <span>â­</span> æŸ¥çœ‹æˆ‘çš„æœ€æ„›
                </button>
            </div>

            <div id="list-root"></div>
        </div>
    </div>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ğŸ”´ è‡¨æ™‚ç™»å…¥è¨­å®š
        const TEMP_CONFIG = {
            passcode: "Jiachang",           
            email: "jiachang@guest.com",   
            passwordToken: "SmlhIGNoYW5n", 
            
            duration: 3 * 60 * 1000        
        };

        // ğŸ”´ ä¿®æ”¹ï¼šåœ¨ Console è¼¸å…¥ guest() è§¸ç™¼
        window.guest = function() {
            // ç›´æ¥è·³å‡ºè¼¸å…¥æ¡†å•å¯†ç¢¼
            const inputPass = prompt("ğŸ” è«‹è¼¸å…¥è‡¨æ™‚é€šé—œå¯†ç¢¼ï¼š");
            
            if (!inputPass) {
                console.log("å·²å–æ¶ˆç™»å…¥ã€‚");
                return;
            }

            if (inputPass === TEMP_CONFIG.passcode) {
                console.log("ğŸ”„ å¯†ç¢¼æ­£ç¢ºï¼Œæ­£åœ¨é©—è­‰æ†‘è­‰...");

                // å˜—è©¦è§£ç¢¼å¯†ç¢¼
                let realPassword = "";
                try {
                    realPassword = atob(TEMP_CONFIG.passwordToken);
                } catch(e) {
                    console.error("âŒ è¨­å®šéŒ¯èª¤ï¼šBase64 è§£ç¢¼å¤±æ•—");
                    return;
                }

                if(!realPassword || realPassword.includes("ä½ çš„_BASE64")) {
                    alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šå¥½ Firebase è¨ªå®¢å¯†ç¢¼ï¼");
                    return;
                }

                // UI äº’å‹• (è®“ç•«é¢æœ‰é»åæ‡‰)
                const btn = document.getElementById('loginBtn');
                if(btn) {
                    btn.disabled = true; 
                    btn.innerText = "å¾Œå°æŒ‡ä»¤é©—è­‰ä¸­...";
                }
                
                auth.signInWithEmailAndPassword(TEMP_CONFIG.email, realPassword)
                    .then(() => {
                        console.log("âœ… ç™»å…¥æˆåŠŸï¼è‡¨æ™‚æ¨¡å¼å·²å•Ÿå‹•ã€‚");
                        showMsg("è‡¨æ™‚å­˜å–æ¨¡å¼å·²å•Ÿå‹• (3åˆ†é˜)", "success");
                    })
                    .catch((error) => {
                        if(btn) {
                            btn.disabled = false;
                            btn.innerText = "ç™»å…¥ç³»çµ±";
                        }
                        console.error("âŒ ç™»å…¥å¤±æ•—:", error);
                        alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase å¸³è™Ÿè¨­å®šã€‚");
                    });
            } else {
                console.error("ğŸš« å¯†ç¢¼éŒ¯èª¤ï¼");
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        };
        
        // æç¤ºè¨Šæ¯
        console.log("%cğŸ”§ ç³»çµ±å·²å°±ç·’ã€‚å¦‚éœ€è¨ªå®¢ç™»å…¥ï¼Œè«‹è¼¸å…¥ guest() ä¸¦æŒ‰ Enterã€‚", "color: #3498db; font-size: 12px; font-weight: bold;");

        // ğŸŸ¢ 2. æ™ºæ…§å•å€™
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "æ—©å®‰";
            if (hour < 18) return "åˆå®‰";
            return "æ™šå®‰";
        }

        // ğŸŸ¢ 3. æ·±è‰²æ¨¡å¼
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        function updateThemeIcon(theme) {
            document.getElementById('theme-icon').innerText = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // ğŸŸ¢ 4. ç›£è½å…¬å‘Š
        function listenForAnnouncements() {
            db.collection("system").doc("announcement").onSnapshot((doc) => {
                const bar = document.getElementById('announcement-bar');
                if (doc.exists && doc.data().active && doc.data().text) {
                    bar.classList.remove('hidden');
                    document.getElementById('announcement-text').innerText = doc.data().text;
                } else {
                    bar.classList.add('hidden');
                }
            });
        }

        initTheme();

        // Auth ç›£è½
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserStatus(user);
            } else {
                document.getElementById('loading-mask').style.display = 'none';
            }
        });

        // ä»‹é¢åˆ‡æ›
        function switchMode(mode) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('msg-box').innerText = '';
            if (mode === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }
        function showMsg(text, type) {
            const el = document.getElementById('msg-box');
            el.innerText = text;
            el.className = 'msg ' + type;
        }

        // è¨»å†Šèˆ‡ç™»å…¥
        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();
            if(!name || !email || !pass) return showMsg("æ‰€æœ‰æ¬„ä½éƒ½è¦å¡«å¯«å–”", "error");
            if(pass.length < 6) return showMsg("å¯†ç¢¼è‡³å°‘è¦ 6 å€‹å­—", "error");
            const btn = document.getElementById('regBtn');
            btn.disabled = true; btn.innerText = "è¨»å†Šä¸­...";
            auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => {
                return db.collection("users").doc(userCredential.user.uid).set({
                    name: name, email: email, status: "pending", createdAt: new Date()
                });
            }).then(() => {
                showMsg("è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…æ ¸å‡†ã€‚", "success");
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                auth.signOut(); setTimeout(() => switchMode('login'), 3000);
            }).catch((error) => {
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                showMsg("è¨»å†Šå¤±æ•—: " + error.message, "error");
            });
        }
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            if(!email || !pass) return showMsg("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼", "error");
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­...";
            auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                showMsg("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤", "error");
            });
        }
        
        function checkUserStatus(user) {
            db.collection("users").doc(user.uid).get().then((doc) => {
                document.getElementById('loading-mask').style.display = 'none';
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.status === 'approved') {
                        enterSite(userData.name);

                        // ğŸ”´ æ–°å¢ï¼šå¦‚æœæ˜¯è‡¨æ™‚å¸³è™Ÿï¼Œå•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨
                        if (user.email === TEMP_CONFIG.email) {
                            console.log(`è‡¨æ™‚æ¨¡å¼å•Ÿå‹•ï¼š${TEMP_CONFIG.duration / 1000}ç§’å¾Œç™»å‡º`);
                            
                            // é¡¯ç¤ºä¸€å€‹å€’æ•¸æç¤º
                            const announceBar = document.getElementById('announcement-bar');
                            announceBar.classList.remove('hidden');
                            document.getElementById('announcement-text').innerText = `âš ï¸ é€™æ˜¯è‡¨æ™‚ç™»å…¥æ¨¡å¼ï¼Œç³»çµ±å°‡åœ¨ 3 åˆ†é˜å¾Œè‡ªå‹•ç™»å‡ºã€‚`;

                            // è¨­å®šå®šæ™‚ç‚¸å½ˆ
                            setTimeout(() => {
                                auth.signOut().then(() => {
                                    alert("â³ è‡¨æ™‚å­˜å–æ™‚é–“çµæŸï¼Œå·²è‡ªå‹•ç™»å‡ºã€‚");
                                    location.reload();
                                });
                            }, TEMP_CONFIG.duration);
                        }

                    } else {
                        auth.signOut();
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('loginBtn').innerText = "ç™»å…¥ç³»çµ±";
                        showMsg("æ‚¨çš„å¸³è™Ÿå°šåœ¨å¯©æ ¸ä¸­ã€‚", "error");
                    }
                } else { showMsg("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™", "error"); }
            }).catch((error) => { document.getElementById('loading-mask').style.display = 'none'; showMsg("è®€å–è³‡æ–™å¤±æ•—", "error"); });
        }

        function showLogoutModal() {
            const overlay = document.getElementById('custom-modal-overlay');
            const box = overlay.querySelector('.modal-box');

            box.innerHTML = `
                <div class="modal-icon-wrapper icon-warning">âš ï¸</div>
                <div class="modal-title">ç¢ºèªæ“ä½œ</div>
                <div class="modal-desc">æ‚¨ç¢ºå®šè¦ç™»å‡ºç›®å‰çš„å¸³è™Ÿå—ï¼Ÿ</div>
                <div class="modal-btn-group">
                    <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn btn-confirm-red" onclick="performLogout()">ç¢ºå®š</button>
                </div>
            `;
            overlay.style.display = 'flex';
            setTimeout(() => { overlay.classList.add('show'); }, 10);
        }

        function performLogout() {
            auth.signOut().then(() => location.reload());
        }

        // --- ğŸŸ¢ æ ¸å¿ƒï¼šå¾é›²ç«¯è®€å–æª”æ¡ˆçµæ§‹ (åŒ…å«æœ€æ„›èˆ‡ç¯©é¸é‚è¼¯) ---
        let pathStack = [];
        let allFilesFlat = [];
        let allFoldersFlat = []; 
        let cloudItems = []; 
        let userFavorites = []; 
        let userPinned = []; // ğŸŸ¢ æ–°å¢ï¼šå„²å­˜ä½¿ç”¨è€…çš„ç½®é ‚é …ç›®
        let isViewFavoritesMode = false;

        // ğŸŸ¢ ä¿®æ”¹å¾Œçš„ enterSite (è®€å–æœ€æ„› + ç½®é ‚)
        function enterSite(userName) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${getGreeting()}ï¼Œ${userName}`;
            
            const uid = auth.currentUser.uid;
            db.collection("users").doc(uid).get().then((doc) => {
                if(doc.exists) {
                    const d = doc.data();
                    userFavorites = d.favorites || [];
                    userPinned = d.pinned || []; // ğŸŸ¢ è®€å–ç½®é ‚
                } else {
                    userFavorites = [];
                    userPinned = [];
                }
                initSite(); 
                listenForAnnouncements(); 
            });
        }

        function initSite() {
            document.title = CONFIG.pageTitle;
            document.getElementById("page-title").innerText = CONFIG.pageTitle;
            
            db.collection('system').doc('files').onSnapshot(doc => {
                if (doc.exists && doc.data().items) {
                    cloudItems = doc.data().items;
                    allFilesFlat = flattenItems(cloudItems);
                    
                    allFoldersFlat = [];
                    processFolderPaths(cloudItems);

                    const isSearching = document.querySelector('.nav-bar').classList.contains('hidden');
                    
                    if(isSearching && !isViewFavoritesMode) {
                        handleSearch();
                    } else {
                        refreshCurrentView();
                    }
                } else {
                    cloudItems = [];
                    allFilesFlat = [];
                    allFoldersFlat = [];
                    renderList([]);
                }
            }, error => {
                console.error("ç›£è½å¤±æ•—:", error);
            });
        }

        // ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ·æ–°ç•«é¢ (åŒ…å«æ’åºèˆ‡ç¯©é¸é‚è¼¯)
        function refreshCurrentView() {
            let itemsToRender = [];

            if (isViewFavoritesMode) {
                const allItems = [...allFilesFlat, ...allFoldersFlat];
                itemsToRender = allItems.filter(item => userFavorites.includes(item.path));
                document.getElementById("breadcrumb-container").innerHTML = `<span class="breadcrumb-current">â­ æˆ‘çš„æœ€æ„›</span>`;
                document.getElementById("backBtn").classList.remove("hidden");
                document.getElementById("backBtn").onclick = exitFavoritesView;
            } else if (document.querySelector('.nav-bar').classList.contains('hidden')) {
                return; 
            } else {
                if (pathStack.length === 0) {
                    itemsToRender = cloudItems;
                } else {
                    itemsToRender = pathStack[pathStack.length - 1].children || [];
                }
                updateBreadcrumb();
            }

            const filterType = document.getElementById('filterSelect').value;
            if (filterType !== 'all') {
                itemsToRender = itemsToRender.filter(item => {
                    if (item.type === 'folder') return true; 
                    let fileType = getFileType(item);
                    if (filterType === 'doc') return ['doc', 'pdf', 'ppt'].includes(fileType);
                    if (filterType === 'video') return fileType === 'video';
                    if (filterType === 'img') return fileType === 'img';
                    return true;
                });
            }

            const sortType = document.getElementById('sortSelect').value;
            
            // ğŸŸ¢ ä¿®æ”¹æ’åºé‚è¼¯ï¼šç½®é ‚é …ç›®æ°¸é åœ¨æœ€ä¸Šé¢
            itemsToRender = [...itemsToRender].sort((a, b) => {
                const isAPinned = userPinned.includes(a.path);
                const isBPinned = userPinned.includes(b.path);

                // ç½®é ‚åˆ¤æ–· (Aç½®é ‚ Bä¸ç½®é ‚ -> Aåœ¨å‰)
                if (isAPinned && !isBPinned) return -1;
                if (!isAPinned && isBPinned) return 1;

                // åŸæœ‰æ’åºé‚è¼¯
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;

                if (sortType === 'name_asc') return a.name.localeCompare(b.name, "zh-Hant");
                if (sortType === 'name_desc') return b.name.localeCompare(a.name, "zh-Hant");
                if (sortType === 'type') {
                    return (a.type || '').localeCompare(b.type || '');
                }
                return 0;
            });

            renderList(itemsToRender);
        }

        // è¼”åŠ©ï¼šå–å¾—æª”æ¡ˆé¡å‹å­—ä¸²
        function getFileType(item) {
            if (item.icon === 'ğŸ¥' || (item.path && item.path.includes('youtu'))) return 'video';
            if (item.icon === 'ğŸ–¼ï¸' || (item.path && item.path.match(/\.(jpg|png|jpeg)$/i))) return 'img';
            if (item.path && item.path.match(/\.pdf$/i)) return 'pdf';
            if (item.path && item.path.match(/\.ppt(x)?$/i)) return 'ppt';
            return 'doc';
        }

        function flattenItems(items) {
            let result = [];
            items.forEach(item => {
                if(item.type === 'file') { result.push(item); } 
                else if(item.type === 'folder' && item.children) { result = result.concat(flattenItems(item.children)); }
            });
            return result;
        }

        function processFolderPaths(items, parentPath = '') {
            items.forEach(item => {
                if (item.type === 'folder') {
                    item.path = parentPath ? parentPath + '/' + item.name : item.name;
                    allFoldersFlat.push(item);
                    if (item.children) {
                        processFolderPaths(item.children, item.path);
                    }
                }
            });
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const navBar = document.querySelector('.nav-bar');
            const toolbar = document.getElementById('toolbar'); 

            if (query.length > 0) {
                navBar.classList.add('hidden');
                toolbar.classList.add('hidden'); 
                isViewFavoritesMode = false; 
                
                const matchedFiles = allFilesFlat.filter(item => 
                    item.name.toLowerCase().includes(query) || (item.note && item.note.toLowerCase().includes(query))
                );
                renderSearchList(matchedFiles, query); 
            } else {
                navBar.classList.remove('hidden');
                toolbar.classList.remove('hidden');
                refreshCurrentView();
            }
        }

        function renderSearchList(items, query) {
            const container = document.getElementById("list-root");
            container.innerHTML = "";
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sub);">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„æª”æ¡ˆ</div>';
                return;
            }
            items.forEach(item => {
                const highlightedName = item.name.replace(new RegExp(query, "gi"), (match) => `<span class="highlight">${match}</span>`);
                renderFileItem(container, item, highlightedName);
            });
        }

        function renderList(items) {
            const container = document.getElementById("list-root");
            container.innerHTML = ""; 
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sub);">(æ­¤åˆ—è¡¨æ˜¯ç©ºçš„)</div>';
                return;
            }
            items.forEach(item => {
                if (item.type === 'folder') {
                    const div = document.createElement("div");
                    
                    const isFav = userFavorites.includes(item.path);
                    const starClass = isFav ? 'active' : '';
                    
                    // ğŸŸ¢ æª¢æŸ¥æ˜¯å¦ç½®é ‚
                    const isPinned = userPinned.includes(item.path);
                    const pinClass = isPinned ? 'active' : '';
                    const pinnedItemClass = isPinned ? 'is-pinned' : ''; // ç”¨æ–¼èƒŒæ™¯è‰²

                    div.className = `list-item folder-item ${pinnedItemClass}`;
                    
                    // ğŸŸ¢ åŠ å…¥åœ–é‡˜èˆ‡æ˜Ÿæ˜Ÿ
                    div.innerHTML = `
                        <div class="action-icons">
                            <span class="icon-btn star-icon ${starClass}" onclick="toggleFavorite(event, '${item.path}')">â˜…</span>
                            <span class="icon-btn pin-icon ${pinClass}" onclick="togglePin(event, '${item.path}')">ğŸ“Œ</span>
                        </div>
                        <div class="item-icon">ğŸ“</div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-note">${item.children ? item.children.length + ' å€‹é …ç›®' : 'ç©ºè³‡æ–™å¤¾'}</div>
                        </div>
                        <div class="item-arrow">â¤</div>`;
                        
                    div.onclick = (e) => {
                          if(!e.target.classList.contains('icon-btn')) {
                            enterFolder(item);
                          }
                    };
                    container.appendChild(div);
                } else {
                    renderFileItem(container, item, item.name);
                }
            });
        }

        function renderFileItem(container, item, displayName) {
            const div = document.createElement("div");
            
            let icon = item.icon; 
            if (item.path && (item.path.startsWith('http://') || item.path.startsWith('https://'))) {
                const isYoutube = item.path.includes('youtu');
                const isImage = item.path.match(/\.(jpg|png|jpeg|gif|webp)$/i);
                if (!isYoutube && !isImage) icon = 'ğŸ”—';
            }
            if (!icon) icon = (item.path && item.path.match(/\.(pdf|doc|docx|ppt|pptx|xls|xlsx)$/i)) ? 'ğŸ“„' : 'ğŸ“„';

            let fileType = getFileType(item);
            
            const isFav = userFavorites.includes(item.path);
            const starClass = isFav ? 'active' : '';

            // ğŸŸ¢ æª¢æŸ¥æ˜¯å¦ç½®é ‚
            const isPinned = userPinned.includes(item.path);
            const pinClass = isPinned ? 'active' : '';
            const pinnedItemClass = isPinned ? 'is-pinned' : '';

            div.className = `list-item file-item ${pinnedItemClass}`;
            
            // ğŸŸ¢ åŠ å…¥åœ–é‡˜èˆ‡æ˜Ÿæ˜Ÿ
            div.innerHTML = `
                <div class="action-icons">
                    <span class="icon-btn star-icon ${starClass}" onclick="toggleFavorite(event, '${item.path}')">â˜…</span>
                    <span class="icon-btn pin-icon ${pinClass}" onclick="togglePin(event, '${item.path}')">ğŸ“Œ</span>
                </div>
                <div class="item-icon" data-type="${fileType}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${displayName}</div>
                    <div class="item-note">${item.note || ''}</div>
                </div>`;
            
            div.onclick = (e) => {
                if(!e.target.classList.contains('icon-btn')) {
                    window.open(item.path, '_blank');
                }
            };
            container.appendChild(div);
        }

        function showModal(title, desc, type) {
            const overlay = document.getElementById('custom-modal-overlay');
            const box = overlay.querySelector('.modal-box');
            
            let iconClass = 'icon-blue';
            let iconText = 'â„¹ï¸';

            if (type === 'success') { iconClass = 'icon-green'; iconText = 'âœ…'; }
            else if (type === 'error') { iconClass = 'icon-red'; iconText = 'ğŸ—‘ï¸'; }

            box.innerHTML = `
                <div class="modal-icon-wrapper ${iconClass}">${iconText}</div>
                <div class="modal-title">${title}</div>
                <div class="modal-desc">${desc}</div>
                <button class="modal-btn" onclick="closeModal()">å¥½ï¼Œæˆ‘çŸ¥é“äº†</button>
            `;
            
            overlay.style.display = 'flex';
            setTimeout(() => { overlay.classList.add('show'); }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('custom-modal-overlay');
            overlay.classList.remove('show');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        }

        // 1. åˆ‡æ›æ”¶è—ç‹€æ…‹
        function toggleFavorite(e, path) {
            e.stopPropagation();
            const uid = auth.currentUser.uid;
            
            if (userFavorites.includes(path)) {
                userFavorites = userFavorites.filter(p => p !== path);
                showModal("å·²ç§»é™¤", "æ­¤é …ç›®å·²å¾æ‚¨çš„æœ€æ„›æ¸…å–®ä¸­ç§»é™¤ã€‚", "error");
            } else {
                userFavorites.push(path);
                showModal("æˆåŠŸåŠ å…¥", "å·²æˆåŠŸå°‡æ­¤é …ç›®åŠ å…¥æ‚¨çš„æœ€æ„›æ¸…å–® â­", "success");
            }

            if (e.target.classList.contains('active')) e.target.classList.remove('active');
            else e.target.classList.add('active');

            if (isViewFavoritesMode) refreshCurrentView();

            db.collection("users").doc(uid).update({ favorites: userFavorites })
              .catch(err => { db.collection("users").doc(uid).set({ favorites: userFavorites }, { merge: true }); });
        }

        // ğŸŸ¢ æ–°å¢ï¼šåˆ‡æ›ç½®é ‚ç‹€æ…‹
        function togglePin(e, path) {
            e.stopPropagation();
            const uid = auth.currentUser.uid;
            
            if (userPinned.includes(path)) {
                // å–æ¶ˆç½®é ‚
                userPinned = userPinned.filter(p => p !== path);
                showModal("å–æ¶ˆç½®é ‚", "æ­¤é …ç›®å·²æ¢å¾©ä¸€èˆ¬æ’åºã€‚", "error");
            } else {
                // åŠ å…¥ç½®é ‚
                userPinned.push(path);
                showModal("å·²ç½®é ‚", "æ­¤é …ç›®å°‡æœƒå›ºå®šåœ¨åˆ—è¡¨æœ€ä¸Šæ–¹ ğŸ“Œ", "success");
            }

            // å³æ™‚æ›´æ–°ç•«é¢
            refreshCurrentView();

            // å¯«å…¥è³‡æ–™åº«
            db.collection("users").doc(uid).update({ pinned: userPinned })
              .catch(err => { db.collection("users").doc(uid).set({ pinned: userPinned }, { merge: true }); });
        }

        function toggleFavoritesView() {
            isViewFavoritesMode = true;
            document.getElementById('searchInput').value = ''; 
            document.querySelector('.nav-bar').classList.remove('hidden'); 
            refreshCurrentView();
        }

        function exitFavoritesView() {
            isViewFavoritesMode = false;
            pathStack = []; 
            document.getElementById("backBtn").onclick = goUp; 
            refreshCurrentView();
        }

        function enterFolder(folderItem) { 
            isViewFavoritesMode = false; 
            pathStack.push(folderItem); 
            refreshCurrentView(); 
        }

        function goUp() { 
            if (pathStack.length > 0) { 
                pathStack.pop(); 
                refreshCurrentView(); 
            } 
        }

        function jumpTo(index) { 
            isViewFavoritesMode = false;
            if (index === -1) { 
                pathStack = []; 
            } else { 
                pathStack = pathStack.slice(0, index + 1); 
            } 
            refreshCurrentView(); 
        }

        function updateBreadcrumb() {
            const backBtn = document.getElementById("backBtn");
            if (pathStack.length > 0) {
                backBtn.classList.remove("hidden");
                backBtn.onclick = goUp; 
            } else {
                backBtn.classList.add("hidden");
            }
            
            let html = `<span class="breadcrumb-item" onclick="jumpTo(-1)">é¦–é </span>`;
            pathStack.forEach((folder, index) => {
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === pathStack.length - 1) {
                    html += `<span class="breadcrumb-current">${folder.name}</span>`;
                } else {
                    html += `<span class="breadcrumb-item" onclick="jumpTo(${index})">${folder.name}</span>`;
                }
            });
            document.getElementById("breadcrumb-container").innerHTML = html;
        }
    </script>
</body>
</html>
