<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å­¸è³‡æºåº« - æœƒå“¡ç™»å…¥</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f5f7fa; margin: 0; padding: 0; color: #333; height: 100vh; }
        .hidden { display: none !important; }

        /* --- é©—è­‰å€å¡Š --- */
        #auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f7fa; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background: white; padding: 40px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 100%; max-width: 380px;
        }
        .auth-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .auth-tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: #999; font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: #3498db; border-bottom: 2px solid #3498db; margin-bottom: -2px; }
        
        .form-title { text-align: center; margin-bottom: 20px; color: #2c3e50; font-size: 22px; font-weight: 700; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #3498db; outline: none; background: #fbfdff; }
        
        button.action-btn { width: 100%; padding: 14px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button.action-btn:hover { background-color: #2980b9; transform: translateY(-1px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }

        .msg { font-size: 14px; text-align: center; margin-top: 20px; min-height: 20px; line-height: 1.5; }
        .msg.error { color: #e74c3c; }
        .msg.success { color: #27ae60; }

        /* --- ä¸»å…§å®¹å€ --- */
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; min-height: 500px; display: flex; flex-direction: column; }
        .header-bar { background: #fff; padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .brand { font-size: 20px; font-weight: 700; color: #2c3e50; display: flex; align-items: center; }
        .logout-btn { font-size: 14px; color: #e74c3c; cursor: pointer; border: 1px solid #eee; padding: 6px 12px; border-radius: 6px; transition: 0.2s; }
        .logout-btn:hover { background: #fff1f0; border-color: #e74c3c; }
        .nav-bar { background: #f8f9fa; padding: 12px 30px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 14px; color: #666; }
        .breadcrumb { display: flex; align-items: center; flex-grow: 1; overflow-x: auto; white-space: nowrap; }
        .breadcrumb-item { cursor: pointer; color: #0366d6; font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: #aaa; }
        .breadcrumb-current { color: #333; font-weight: bold; cursor: default; }
        .back-btn { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 15px; display: flex; align-items: center; color: #555; }
        #list-root { padding: 10px 0; flex-grow: 1; }
        .list-item { display: flex; align-items: center; padding: 16px 30px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { background-color: #f0f7ff; padding-left: 35px; }
        .item-icon { font-size: 28px; margin-right: 20px; min-width: 40px; text-align: center; }
        .item-info { flex-grow: 1; }
        .item-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .item-note { font-size: 13px; color: #888; }
        .item-arrow { color: #ccc; font-size: 14px; }
        .folder-item .item-icon { color: #f39c12; }
        .file-item .item-icon { color: #3498db; }
        .file-item:hover .item-name { color: #0366d6; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchMode('login')">æœƒå“¡ç™»å…¥</div>
                <div class="auth-tab" onclick="switchMode('register')">è¨»å†Šå¸³è™Ÿ</div>
            </div>

            <div id="login-form">
                <div class="form-title">æ­¡è¿å›ä¾†</div>
                <div class="input-group"><input type="email" id="loginEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="loginPass" placeholder="å¯†ç¢¼"></div>
                <button class="action-btn" onclick="handleLogin()" id="loginBtn">ç™»å…¥ç³»çµ±</button>
            </div>

            <div id="register-form" class="hidden">
                <div class="form-title">å»ºç«‹æ–°å¸³è™Ÿ</div>
                <div class="input-group"><input type="text" id="regName" placeholder="æ‚¨çš„å§“å (çµ¦è€å¸«çœ‹çš„)"></div>
                <div class="input-group"><input type="email" id="regEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="regPass" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)"></div>
                <button class="action-btn" onclick="handleRegister()" id="regBtn" style="background-color:#27ae60;">æäº¤è¨»å†Šç”³è«‹</button>
            </div>

            <div id="msg-box" class="msg"></div>
        </div>
    </div>

    <div id="content" class="hidden">
        <div class="container">
            <div class="header-bar">
                <div class="brand"><span>ğŸ“‚</span> <div id="page-title">æ•™å­¸è³‡æºåº«</div></div>
                <div class="logout-btn" onclick="logout()">ç™»å‡º <span id="user-display"></span></div>
            </div>
            <div class="nav-bar">
                <button id="backBtn" class="back-btn hidden" onclick="goUp()">è¿”å›</button>
                <div class="breadcrumb" id="breadcrumb-container"></div>
            </div>
            <div id="list-root"></div>
        </div>
    </div>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ 1. åˆå§‹åŒ– Firebase (å·²ç¶“å¹«ä½ å¡«å¥½ä½ çš„å°ˆæ¡ˆè¨­å®šäº†ï¼)
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        // å•Ÿå‹• Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ä»‹é¢åˆ‡æ›é‚è¼¯ ---
        function switchMode(mode) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('msg-box').innerText = '';
            
            if (mode === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }

        function showMsg(text, type) {
            const el = document.getElementById('msg-box');
            el.innerText = text;
            el.className = 'msg ' + type;
        }

        // --- åŠŸèƒ½ï¼šè¨»å†Š ---
        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();

            if(!name || !email || !pass) return showMsg("æ‰€æœ‰æ¬„ä½éƒ½è¦å¡«å¯«å–”", "error");
            if(pass.length < 6) return showMsg("å¯†ç¢¼è‡³å°‘è¦ 6 å€‹å­—", "error");

            const btn = document.getElementById('regBtn');
            btn.disabled = true;
            btn.innerText = "è¨»å†Šä¸­...";

            // 1. å»ºç«‹ Firebase å¸³è™Ÿ
            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    // 2. å¯«å…¥è³‡æ–™åº« (ç‹€æ…‹è¨­ç‚º pending)
                    return db.collection("users").doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        status: "pending", // é è¨­ç‹€æ…‹ï¼šå¾…å¯©æ ¸
                        createdAt: new Date()
                    });
                })
                .then(() => {
                    showMsg("è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…è€å¸«æ ¸å‡†å¾Œæ‰èƒ½ç™»å…¥ã€‚", "success");
                    btn.disabled = false;
                    btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                    auth.signOut(); 
                    setTimeout(() => switchMode('login'), 3000);
                })
                .catch((error) => {
                    btn.disabled = false;
                    btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                    let msg = "è¨»å†Šå¤±æ•—";
                    if(error.code === 'auth/email-already-in-use') msg = "é€™å€‹ Email å·²ç¶“è¨»å†Šéäº†";
                    else if(error.code === 'auth/invalid-email') msg = "Email æ ¼å¼ä¸æ­£ç¢º";
                    else if(error.code === 'permission-denied') msg = "æ¬Šé™ä¸è¶³ï¼šè«‹æª¢æŸ¥ Firebase è³‡æ–™åº«è¦å‰‡";
                    showMsg(msg + " (" + error.message + ")", "error");
                });
        }

        // --- åŠŸèƒ½ï¼šç™»å…¥ ---
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value.trim();

            if(!email || !pass) return showMsg("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼", "error");

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";

            auth.signInWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    // ç™»å…¥æˆåŠŸï¼Œæª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹
                    checkUserStatus(userCredential.user);
                })
                .catch((error) => {
                    btn.disabled = false;
                    btn.innerText = "ç™»å…¥ç³»çµ±";
                    console.error(error);
                    showMsg("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤", "error");
                });
        }

        function checkUserStatus(user) {
            db.collection("users").doc(user.uid).get().then((doc) => {
                const btn = document.getElementById('loginBtn');
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.status === 'approved') {
                        // æ ¸å‡†é€šéï¼šé€²å…¥ç¶²ç«™
                        enterSite(userData.name);
                    } else {
                        // å°šæœªæ ¸å‡†
                        auth.signOut();
                        btn.disabled = false;
                        btn.innerText = "ç™»å…¥ç³»çµ±";
                        showMsg("æ‚¨çš„å¸³è™Ÿå°šåœ¨å¯©æ ¸ä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", "error");
                    }
                } else {
                    // æœ‰å¸³è™Ÿä½†æ²’è³‡æ–™åº«ç´€éŒ„ (æ¥µå°‘è¦‹ï¼Œé™¤éæ‰‹å‹•åˆªé™¤è³‡æ–™åº«)
                    showMsg("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™", "error");
                }
            }).catch((error) => {
                console.error(error);
                showMsg("è®€å–è³‡æ–™å¤±æ•— (è«‹æª¢æŸ¥è³‡æ–™åº«è¦å‰‡)", "error");
            });
        }

        // --- é€²å…¥ç¶²ç«™å¾Œçš„åŠŸèƒ½ ---
        function enterSite(userName) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('user-display').innerText = `(${userName})`;
            
            initSite(); 
        }

        function logout() {
            auth.signOut().then(() => {
                location.reload();
            });
        }

        // --- æª”æ¡ˆåˆ—è¡¨é‚è¼¯ ---
        let pathStack = [];

        function initSite() {
            document.title = CONFIG.pageTitle;
            document.getElementById("page-title").innerText = CONFIG.pageTitle;
            renderList(CONFIG.items);
            updateBreadcrumb();
        }

        function renderList(items) {
            const container = document.getElementById("list-root");
            container.innerHTML = ""; 
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">(æ­¤è³‡æ–™å¤¾æ˜¯ç©ºçš„)</div>';
                return;
            }
            items.forEach(item => {
                const div = document.createElement("div");
                if (item.type === 'folder') {
                    div.className = "list-item folder-item";
                    div.innerHTML = `<div class="item-icon">ğŸ“</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-note">${item.children ? item.children.length + ' å€‹é …ç›®' : 'ç©ºè³‡æ–™å¤¾'}</div></div><div class="item-arrow">â¤</div>`;
                    div.onclick = () => enterFolder(item);
                } else {
                    let icon = item.icon || 'ğŸ“„'; 
                    div.className = "list-item file-item";
                    div.innerHTML = `<div class="item-icon">${icon}</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-note">${item.note || ''}</div></div>`;
                    div.onclick = () => window.open(item.path, '_blank');
                }
                container.appendChild(div);
            });
        }

        function enterFolder(folderItem) {
            pathStack.push(folderItem);
            renderList(folderItem.children);
            updateBreadcrumb();
        }

        function goUp() {
            if (pathStack.length > 0) {
                pathStack.pop(); 
                if (pathStack.length === 0) renderList(CONFIG.items);
                else renderList(pathStack[pathStack.length - 1].children);
                updateBreadcrumb();
            }
        }

        function jumpTo(index) {
            if (index === -1) {
                pathStack = [];
                renderList(CONFIG.items);
            } else {
                pathStack = pathStack.slice(0, index + 1);
                renderList(pathStack[pathStack.length - 1].children);
            }
            updateBreadcrumb();
        }

        function updateBreadcrumb() {
            const bcContainer = document.getElementById("breadcrumb-container");
            const backBtn = document.getElementById("backBtn");
            if (pathStack.length > 0) backBtn.classList.remove("hidden");
            else backBtn.classList.add("hidden");
            let html = `<span class="breadcrumb-item" onclick="jumpTo(-1)">é¦–é </span>`;
            pathStack.forEach((folder, index) => {
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === pathStack.length - 1) html += `<span class="breadcrumb-current">${folder.name}</span>`;
                else html += `<span class="breadcrumb-item" onclick="jumpTo(${index})">${folder.name}</span>`;
            });
            bcContainer.innerHTML = html;
        }
    </script>
</body>
</html>
