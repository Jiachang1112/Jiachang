<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å­¸è³‡æºåº«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f5f7fa; margin: 0; padding: 0; color: #333; height: 100vh; }
        .hidden { display: none !important; }

        /* --- è¼‰å…¥ä¸­é®ç½© --- */
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #3498db; font-weight: bold; font-size: 18px; }
        .spinner { border: 4px solid #eee; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- é©—è­‰å€å¡Š (ç¶­æŒä¸è®Š) --- */
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f7fa; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        .auth-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .auth-tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: #999; font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: #3498db; border-bottom: 2px solid #3498db; margin-bottom: -2px; }
        .form-title { text-align: center; margin-bottom: 20px; color: #2c3e50; font-size: 22px; font-weight: 700; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #3498db; outline: none; background: #fbfdff; }
        button.action-btn { width: 100%; padding: 14px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button.action-btn:hover { background-color: #2980b9; transform: translateY(-1px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }
        .msg { font-size: 14px; text-align: center; margin-top: 20px; min-height: 20px; line-height: 1.5; }
        .msg.error { color: #e74c3c; }
        .msg.success { color: #27ae60; }

        /* --- ä¸»å…§å®¹å€ --- */
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; min-height: 500px; display: flex; flex-direction: column; position: relative; }
        .header-bar { background: #fff; padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .brand { font-size: 20px; font-weight: 700; color: #2c3e50; display: flex; align-items: center; }
        
        /* User Profile & Logout */
        .user-profile { display: flex; align-items: center; background: #f8f9fa; padding: 5px 15px; border-radius: 20px; border: 1px solid #eee; }
        .user-name { font-size: 14px; color: #333; font-weight: bold; margin-right: 10px; }
        .logout-btn { font-size: 12px; color: #e74c3c; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: 0.2s; background: white; border: 1px solid #eee; }
        .logout-btn:hover { background: #fff1f0; border-color: #e74c3c; }

        /* ğŸŸ¢ æ–°å¢ï¼šå…¬å‘Šæ¬„æ¨£å¼ */
        #announcement-bar { background: #fff8e1; color: #d35400; padding: 10px 30px; font-size: 14px; border-bottom: 1px solid #ffe0b2; display: flex; align-items: center; }
        #announcement-bar svg { width: 18px; height: 18px; margin-right: 8px; fill: currentColor; }

        /* ğŸŸ¢ æ–°å¢ï¼šæœå°‹æ¡†æ¨£å¼ */
        .search-box { position: relative; width: 250px; }
        .search-box input { width: 100%; padding: 8px 12px 8px 35px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px; height: 36px; }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: #999; pointer-events: none; }

        .nav-bar { background: #f8f9fa; padding: 12px 30px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 14px; color: #666; }
        .breadcrumb { display: flex; align-items: center; flex-grow: 1; overflow-x: auto; white-space: nowrap; }
        .breadcrumb-item { cursor: pointer; color: #0366d6; font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: #aaa; }
        .breadcrumb-current { color: #333; font-weight: bold; cursor: default; }
        .back-btn { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 15px; display: flex; align-items: center; color: #555; }
        
        #list-root { padding: 10px 0; flex-grow: 1; overflow-y: auto; }
        .list-item { display: flex; align-items: center; padding: 16px 30px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { background-color: #f0f7ff; padding-left: 35px; }
        .item-icon { font-size: 28px; margin-right: 20px; min-width: 40px; text-align: center; }
        .item-info { flex-grow: 1; }
        .item-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .item-name .highlight { background: #fff700; color: #000; } /* æœå°‹é«˜äº® */
        .item-note { font-size: 13px; color: #888; }
        .item-arrow { color: #ccc; font-size: 14px; }
        .folder-item .item-icon { color: #f39c12; }
        .file-item .item-icon { color: #3498db; }
        .file-item:hover .item-name { color: #0366d6; }
        
        /* æœå°‹çµæœæ¨¡å¼ */
        .search-mode .folder-item { display: none; } /* æœå°‹æ™‚éš±è—è³‡æ–™å¤¾ */
    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="spinner"></div>
        è³‡æ–™è®€å–ä¸­...
    </div>

    <div id="auth-container">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchMode('login')">æœƒå“¡ç™»å…¥</div>
                <div class="auth-tab" onclick="switchMode('register')">è¨»å†Šå¸³è™Ÿ</div>
            </div>
            <div id="login-form">
                <div class="form-title">æ­¡è¿å›ä¾†</div>
                <div class="input-group"><input type="email" id="loginEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="loginPass" placeholder="å¯†ç¢¼"></div>
                <button class="action-btn" onclick="handleLogin()" id="loginBtn">ç™»å…¥ç³»çµ±</button>
            </div>
            <div id="register-form" class="hidden">
                <div class="form-title">å»ºç«‹æ–°å¸³è™Ÿ</div>
                <div class="input-group"><input type="text" id="regName" placeholder="æ‚¨çš„å§“å (çµ¦è€å¸«çœ‹çš„)"></div>
                <div class="input-group"><input type="email" id="regEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="regPass" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)"></div>
                <button class="action-btn" onclick="handleRegister()" id="regBtn" style="background-color:#27ae60;">æäº¤è¨»å†Šç”³è«‹</button>
            </div>
            <div id="msg-box" class="msg"></div>
        </div>
    </div>

    <div id="content" class="hidden">
        <div class="container">
            <div class="header-bar">
                <div class="brand"><span>ğŸ“‚</span> <div id="page-title">æ•™å­¸è³‡æºåº«</div></div>
                
                <div class="search-box">
                    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" id="searchInput" placeholder="æœå°‹æª”æ¡ˆ..." onkeyup="handleSearch()">
                </div>

                <div class="user-profile">
                    <span class="user-name" id="user-display">User</span>
                    <div class="logout-btn" onclick="logout()">ç™»å‡º</div>
                </div>
            </div>

            <div id="announcement-bar" class="hidden">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                <span id="announcement-text"></span>
            </div>

            <div class="nav-bar">
                <button id="backBtn" class="back-btn hidden" onclick="goUp()">è¿”å›</button>
                <div class="breadcrumb" id="breadcrumb-container"></div>
            </div>
            <div id="list-root"></div>
        </div>
    </div>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // è‡ªå‹•ç›£è½ç™»å…¥
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserStatus(user);
            } else {
                document.getElementById('loading-mask').style.display = 'none';
            }
        });

        // ä»‹é¢åˆ‡æ›
        function switchMode(mode) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('msg-box').innerText = '';
            if (mode === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }
        function showMsg(text, type) {
            const el = document.getElementById('msg-box');
            el.innerText = text;
            el.className = 'msg ' + type;
        }

        // è¨»å†Šèˆ‡ç™»å…¥
        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();
            if(!name || !email || !pass) return showMsg("æ‰€æœ‰æ¬„ä½éƒ½è¦å¡«å¯«å–”", "error");
            if(pass.length < 6) return showMsg("å¯†ç¢¼è‡³å°‘è¦ 6 å€‹å­—", "error");
            const btn = document.getElementById('regBtn');
            btn.disabled = true; btn.innerText = "è¨»å†Šä¸­...";
            auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => {
                return db.collection("users").doc(userCredential.user.uid).set({
                    name: name, email: email, status: "pending", createdAt: new Date()
                });
            }).then(() => {
                showMsg("è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…æ ¸å‡†ã€‚", "success");
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                auth.signOut(); setTimeout(() => switchMode('login'), 3000);
            }).catch((error) => {
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                showMsg("è¨»å†Šå¤±æ•—: " + error.message, "error");
            });
        }
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            if(!email || !pass) return showMsg("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼", "error");
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­...";
            auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                showMsg("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤", "error");
            });
        }
        function checkUserStatus(user) {
            db.collection("users").doc(user.uid).get().then((doc) => {
                document.getElementById('loading-mask').style.display = 'none';
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.status === 'approved') {
                        enterSite(userData.name);
                    } else {
                        auth.signOut();
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('loginBtn').innerText = "ç™»å…¥ç³»çµ±";
                        showMsg("æ‚¨çš„å¸³è™Ÿå°šåœ¨å¯©æ ¸ä¸­ã€‚", "error");
                    }
                } else { showMsg("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™", "error"); }
            }).catch((error) => { document.getElementById('loading-mask').style.display = 'none'; showMsg("è®€å–è³‡æ–™å¤±æ•—", "error"); });
        }
        function enterSite(userName) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('user-display').innerText = userName;
            initSite(); 
        }
        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                auth.signOut().then(() => location.reload());
            }
        }

        // --- ğŸŸ¢ æœå°‹èˆ‡æª”æ¡ˆé¡¯ç¤ºé‚è¼¯ ---
        let pathStack = [];
        let allFilesFlat = []; // ç”¨ä¾†å­˜æ‰€æœ‰æª”æ¡ˆçš„æ‰å¹³åˆ—è¡¨ (æ–¹ä¾¿æœå°‹)

        function initSite() {
            document.title = CONFIG.pageTitle;
            document.getElementById("page-title").innerText = CONFIG.pageTitle;
            
            // ğŸŸ¢ è¨­å®šå…¬å‘Š
            if(CONFIG.announcement) {
                document.getElementById('announcement-bar').classList.remove('hidden');
                document.getElementById('announcement-text').innerText = CONFIG.announcement;
            }

            // ğŸŸ¢ é è™•ç†ï¼šæŠŠæ‰€æœ‰æª”æ¡ˆæ‰¾å‡ºä¾†å­˜åˆ° allFilesFlatï¼Œæ–¹ä¾¿æœå°‹
            allFilesFlat = flattenItems(CONFIG.items);

            renderList(CONFIG.items);
            updateBreadcrumb();
        }

        // éè¿´å‡½æ•¸ï¼šæŠŠæ¨¹ç‹€çµæ§‹è½‰æˆæ‰å¹³çµæ§‹
        function flattenItems(items) {
            let result = [];
            items.forEach(item => {
                if(item.type === 'file') {
                    result.push(item);
                } else if(item.type === 'folder' && item.children) {
                    result = result.concat(flattenItems(item.children));
                }
            });
            return result;
        }

        // ğŸŸ¢ æœå°‹åŠŸèƒ½
        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const listRoot = document.getElementById('list-root');
            const navBar = document.querySelector('.nav-bar');

            if (query.length > 0) {
                // é€²å…¥æœå°‹æ¨¡å¼
                navBar.classList.add('hidden'); // éš±è—éºµåŒ…å±‘
                listRoot.classList.add('search-mode');
                
                // éæ¿¾æª”æ¡ˆ
                const matchedFiles = allFilesFlat.filter(item => 
                    item.name.toLowerCase().includes(query) || 
                    (item.note && item.note.toLowerCase().includes(query))
                );
                
                renderSearchList(matchedFiles, query);
            } else {
                // å›å¾©æ­£å¸¸æ¨¡å¼
                navBar.classList.remove('hidden');
                listRoot.classList.remove('search-mode');
                
                // é¡¯ç¤ºç•¶å‰è³‡æ–™å¤¾
                if(pathStack.length === 0) renderList(CONFIG.items);
                else renderList(pathStack[pathStack.length - 1].children);
            }
        }

        function renderSearchList(items, query) {
            const container = document.getElementById("list-root");
            container.innerHTML = "";
            
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„æª”æ¡ˆ</div>';
                return;
            }

            items.forEach(item => {
                // é«˜äº®é¡¯ç¤ºé—œéµå­—
                const highlightedName = item.name.replace(new RegExp(query, "gi"), (match) => `<span class="highlight">${match}</span>`);

                const div = document.createElement("div");
                let icon = item.icon || 'ğŸ“„'; 
                div.className = "list-item file-item";
                div.innerHTML = `
                    <div class="item-icon">${icon}</div>
                    <div class="item-info">
                        <div class="item-name">${highlightedName}</div>
                        <div class="item-note">${item.note || ''}</div>
                    </div>`;
                div.onclick = () => window.open(item.path, '_blank');
                container.appendChild(div);
            });
        }

        // æ­£å¸¸æ¸²æŸ“åˆ—è¡¨ (è·Ÿä¹‹å‰ä¸€æ¨£)
        function renderList(items) {
            const container = document.getElementById("list-root");
            container.innerHTML = ""; 
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">(æ­¤è³‡æ–™å¤¾æ˜¯ç©ºçš„)</div>';
                return;
            }
            items.forEach(item => {
                const div = document.createElement("div");
                if (item.type === 'folder') {
                    div.className = "list-item folder-item";
                    div.innerHTML = `<div class="item-icon">ğŸ“</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-note">${item.children ? item.children.length + ' å€‹é …ç›®' : 'ç©ºè³‡æ–™å¤¾'}</div></div><div class="item-arrow">â¤</div>`;
                    div.onclick = () => enterFolder(item);
                } else {
                    let icon = item.icon || 'ğŸ“„'; 
                    div.className = "list-item file-item";
                    div.innerHTML = `<div class="item-icon">${icon}</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-note">${item.note || ''}</div></div>`;
                    div.onclick = () => window.open(item.path, '_blank');
                }
                container.appendChild(div);
            });
        }
        function enterFolder(folderItem) { pathStack.push(folderItem); renderList(folderItem.children); updateBreadcrumb(); }
        function goUp() { if (pathStack.length > 0) { pathStack.pop(); if (pathStack.length === 0) renderList(CONFIG.items); else renderList(pathStack[pathStack.length - 1].children); updateBreadcrumb(); } }
        function jumpTo(index) { if (index === -1) { pathStack = []; renderList(CONFIG.items); } else { pathStack = pathStack.slice(0, index + 1); renderList(pathStack[pathStack.length - 1].children); } updateBreadcrumb(); }
        function updateBreadcrumb() {
            const bcContainer = document.getElementById("breadcrumb-container");
            const backBtn = document.getElementById("backBtn");
            if (pathStack.length > 0) backBtn.classList.remove("hidden"); else backBtn.classList.add("hidden");
            let html = `<span class="breadcrumb-item" onclick="jumpTo(-1)">é¦–é </span>`;
            pathStack.forEach((folder, index) => {
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === pathStack.length - 1) html += `<span class="breadcrumb-current">${folder.name}</span>`;
                else html += `<span class="breadcrumb-item" onclick="jumpTo(${index})">${folder.name}</span>`;
            });
            bcContainer.innerHTML = html;
        }
    </script>
</body>
</html>
