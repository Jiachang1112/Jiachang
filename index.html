<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å­¸è³‡æºåº«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ğŸ¨ CSS è®Šæ•¸ç³»çµ± --- */
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #2c3e50; --text-sub: #666666; --border: #eeeeee; --accent: #3498db; --accent-hover: #2980b9; --shadow: 0 4px 20px rgba(0,0,0,0.05); --folder-bg: #f8f9fa; --announce-bg: #fff3cd; --announce-text: #856404; }
        [data-theme="dark"] { --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sub: #a0a0a0; --border: #333333; --accent: #4fa3e0; --accent-hover: #6ab0e6; --shadow: 0 4px 20px rgba(0,0,0,0.3); --folder-bg: #2d2d2d; --announce-bg: #3e3825; --announce-text: #ffca2c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); height: 100vh; transition: background 0.3s, color 0.3s; }
        .hidden { display: none !important; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--accent); font-weight: bold; font-size: 18px; transition: 0.3s; }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: var(--shadow); width: 100%; max-width: 380px; transition: 0.3s; }
        .auth-tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 25px; }
        .auth-tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: var(--text-sub); font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); margin-bottom: -2px; }
        .form-title { text-align: center; margin-bottom: 20px; color: var(--text-main); font-size: 22px; font-weight: 700; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; background: var(--bg-color); color: var(--text-main); font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--accent); outline: none; }
        button.action-btn { width: 100%; padding: 14px; background-color: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        button.action-btn:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .msg { font-size: 14px; text-align: center; margin-top: 20px; min-height: 20px; }
        .msg.error { color: #e74c3c; }
        .msg.success { color: #27ae60; }
        .container { max-width: 900px; margin: 20px auto; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; min-height: 80vh; display: flex; flex-direction: column; transition: 0.3s; }
        .header-bar { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        
        .brand { font-size: 22px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; }
        
        .brand-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            pointer-events: none;
            cursor: default;
        }
        .brand-link span:first-child { margin-right: 8px; }

        .header-tools { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .search-box { position: relative; width: 200px; }
        .search-box input { width: 100%; padding: 8px 12px 8px 35px; border-radius: 20px; border: 1px solid var(--border); font-size: 14px; height: 38px; background: var(--bg-color); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none; }
        .theme-toggle { cursor: pointer; padding: 8px; border-radius: 50%; background: var(--bg-color); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; color: var(--text-main); transition: 0.2s; }
        .theme-toggle:hover { background: var(--border); }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--bg-color); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); }
        .user-name { font-size: 14px; color: var(--text-main); font-weight: bold; }
        .logout-btn { font-size: 12px; color: #e74c3c; cursor: pointer; font-weight: bold; }
        #announcement-bar { background: var(--announce-bg); color: var(--announce-text); padding: 12px 30px; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; transition: 0.3s; }
        #announcement-bar svg { width: 18px; height: 18px; margin-right: 8px; fill: currentColor; }
        .nav-bar { background: var(--folder-bg); padding: 12px 30px; border-bottom: 1px solid var(--border); display: flex; align-items: center; font-size: 14px; color: var(--text-sub); }
        .breadcrumb { display: flex; align-items: center; flex-grow: 1; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .breadcrumb::-webkit-scrollbar { display: none; }
        .breadcrumb-item { cursor: pointer; color: var(--accent); font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-sub); opacity: 0.5; }
        .breadcrumb-current { color: var(--text-main); font-weight: bold; cursor: default; }
        .back-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; margin-right: 15px; display: flex; align-items: center; color: var(--text-main); transition: 0.2s; }
        .back-btn:hover { background: var(--border); }
        #list-root { padding: 10px 0; flex-grow: 1; overflow-y: auto; }
        .list-item { display: flex; align-items: center; padding: 18px 30px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; }
        .list-item:hover { background-color: var(--folder-bg); transform: translateX(5px); }
        .list-item:last-child { border-bottom: none; }
        .item-icon { font-size: 28px; margin-right: 20px; min-width: 40px; text-align: center; transition: 0.2s; }
        .folder-item .item-icon { color: #f39c12; }
        .file-item .item-icon[data-type="pdf"] { color: #e74c3c; } 
        .file-item .item-icon[data-type="doc"] { color: #3498db; }
        .file-item .item-icon[data-type="img"] { color: #9b59b6; }
        .file-item .item-icon[data-type="ppt"] { color: #e67e22; }
        .file-item .item-icon[data-type="video"] { color: #e056fd; }
        .item-info { flex-grow: 1; }
        .item-name { font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 4px; display: flex; align-items: center; }
        .item-name .highlight { background: #ffeaa7; color: #d35400; padding: 0 2px; border-radius: 2px; }
        .item-note { font-size: 13px; color: var(--text-sub); }
        .item-arrow { color: var(--border); font-size: 14px; opacity: 0.5; }
        .folder-item:hover .item-arrow { opacity: 1; color: var(--accent); transform: translateX(3px); transition: 0.2s; }

        /* --- ğŸŸ¢ æ–°å¢ï¼šå·¥å…·åˆ—èˆ‡æˆ‘çš„æœ€æ„›æ¨£å¼ --- */
        .toolbar {
            padding: 10px 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-color);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .tool-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        .fav-btn-view {
            margin-left: auto; /* æ¨åˆ°å³é‚Š */
            background: #f1c40f;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .fav-btn-view:hover { background: #f39c12; transform: translateY(-2px); }

        /* åˆ—è¡¨ä¸­çš„æ˜Ÿæ˜ŸæŒ‰éˆ• */
        .star-icon {
            font-size: 20px;
            cursor: pointer;
            color: #bdc3c7; /* é è¨­ç°è‰² */
            margin-right: 15px;
            transition: 0.2s;
            user-select: none;
        }
        .star-icon:hover { transform: scale(1.2); }
        .star-icon.active { color: #f1c40f; /* å•Ÿç”¨è®Šé‡‘è‰² */ }
        
        @media (max-width: 600px) {
            .container { margin: 0; border-radius: 0; min-height: 100vh; }
            .header-bar { padding: 15px 20px; }
            .header-tools { width: 100%; justify-content: space-between; margin-top: 10px; }
            .search-box { width: 100%; flex-grow: 1; margin-right: 10px; }
            .list-item { padding: 15px 20px; }
            
            /* å·¥å…·åˆ—æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
            .toolbar { padding: 10px 20px; gap: 10px; }
            .tool-select { flex-grow: 1; }
            .fav-btn-view { width: 100%; justify-content: center; margin-left: 0; }
        }

        @media (min-width: 1024px) {
            .container { max-width: 95%; }
            .brand-link { pointer-events: auto; cursor: pointer; }
            .brand-link:hover { opacity: 0.8; }
        }

        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-mask"><div class="spinner"></div><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div id="auth-container">
        <div class="auth-box">
            <div class="auth-tabs"><div class="auth-tab active" onclick="switchMode('login')">æœƒå“¡ç™»å…¥</div><div class="auth-tab" onclick="switchMode('register')">è¨»å†Šå¸³è™Ÿ</div></div>
            <div id="login-form">
                <div class="form-title">ğŸ‘‹ æ­¡è¿å›ä¾†</div>
                <div class="input-group"><input type="email" id="loginEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="loginPass" placeholder="å¯†ç¢¼"></div>
                <button class="action-btn" onclick="handleLogin()" id="loginBtn">ç™»å…¥ç³»çµ±</button>
            </div>
            <div id="register-form" class="hidden">
                <div class="form-title">ğŸ“ å»ºç«‹æ–°å¸³è™Ÿ</div>
                <div class="input-group"><input type="text" id="regName" placeholder="æ‚¨çš„å§“å"></div>
                <div class="input-group"><input type="email" id="regEmail" placeholder="é›»å­ä¿¡ç®±"></div>
                <div class="input-group"><input type="password" id="regPass" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ä½)"></div>
                <button class="action-btn" onclick="handleRegister()" id="regBtn" style="background-color:#27ae60;">æäº¤è¨»å†Šç”³è«‹</button>
            </div>
            <div id="msg-box" class="msg"></div>
        </div>
    </div>

    <div id="content" class="hidden">
        <div class="container">
            <div class="header-bar">
                <div class="brand">
                    <a href="https://jiachang1112.github.io/Jiachang/index.html" class="brand-link" title="https://jiachang1112.github.io/Jiachang/index.html">
                        <span>ğŸ“‚</span> <div id="page-title">æ•™å­¸è³‡æºåº«</div>
                    </a>
                </div>
                <div class="header-tools">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="searchInput" placeholder="æœå°‹é—œéµå­—..." onkeyup="handleSearch()">
                    </div>
                    <div class="theme-toggle" onclick="toggleTheme()"><span id="theme-icon">ğŸŒ™</span></div>
                    <div class="user-profile"><span class="user-name" id="user-display">User</span><div class="logout-btn" onclick="logout()">ç™»å‡º</div></div>
                </div>
            </div>

            <div id="announcement-bar" class="hidden">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                <span id="announcement-text"></span>
            </div>

            <div class="nav-bar">
                <button id="backBtn" class="back-btn hidden" onclick="goUp()">
                    <span style="margin-right:5px;">â¬…</span> è¿”å›
                </button>
                <div class="breadcrumb" id="breadcrumb-container"></div>
            </div>

            <div class="toolbar" id="toolbar">
                <select id="sortSelect" class="tool-select" onchange="refreshCurrentView()">
                    <option value="name_asc">æŒ‰åç¨± (A-Z)</option>
                    <option value="name_desc">æŒ‰åç¨± (Z-A)</option>
                    <option value="type">æŒ‰é¡å‹</option>
                </select>

                <select id="filterSelect" class="tool-select" onchange="refreshCurrentView()">
                    <option value="all">é¡¯ç¤ºå…¨éƒ¨é¡å‹</option>
                    <option value="doc">ğŸ“„ æ–‡ä»¶ (Doc/PDF)</option>
                    <option value="video">ğŸ¥ å½±ç‰‡</option>
                    <option value="img">ğŸ–¼ï¸ åœ–ç‰‡</option>
                </select>

                <button class="fav-btn-view" onclick="toggleFavoritesView()" id="favViewBtn">
                    <span>â­</span> æŸ¥çœ‹æˆ‘çš„æœ€æ„›
                </button>
            </div>

            <div id="list-root"></div>
        </div>
    </div>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ğŸŸ¢ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBZe0HHikgGG9hS3g32jWJ-fzESOTB3Zdw",
            authDomain: "jiachang-2cda4.firebaseapp.com",
            projectId: "jiachang-2cda4",
            storageBucket: "jiachang-2cda4.firebasestorage.app",
            messagingSenderId: "752423213714",
            appId: "1:752423213714:web:e03fc6967d355e9bbc644b",
            measurementId: "G-8GETJKDCEW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ğŸŸ¢ 2. æ™ºæ…§å•å€™
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "æ—©å®‰";
            if (hour < 18) return "åˆå®‰";
            return "æ™šå®‰";
        }

        // ğŸŸ¢ 3. æ·±è‰²æ¨¡å¼
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        function updateThemeIcon(theme) {
            document.getElementById('theme-icon').innerText = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // ğŸŸ¢ 4. ç›£è½å…¬å‘Š
        function listenForAnnouncements() {
            db.collection("system").doc("announcement").onSnapshot((doc) => {
                const bar = document.getElementById('announcement-bar');
                if (doc.exists && doc.data().active && doc.data().text) {
                    bar.classList.remove('hidden');
                    document.getElementById('announcement-text').innerText = doc.data().text;
                } else {
                    bar.classList.add('hidden');
                }
            });
        }

        initTheme();

        // Auth ç›£è½
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserStatus(user);
            } else {
                document.getElementById('loading-mask').style.display = 'none';
            }
        });

        // ä»‹é¢åˆ‡æ›
        function switchMode(mode) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('msg-box').innerText = '';
            if (mode === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }
        function showMsg(text, type) {
            const el = document.getElementById('msg-box');
            el.innerText = text;
            el.className = 'msg ' + type;
        }

        // è¨»å†Šèˆ‡ç™»å…¥
        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();
            if(!name || !email || !pass) return showMsg("æ‰€æœ‰æ¬„ä½éƒ½è¦å¡«å¯«å–”", "error");
            if(pass.length < 6) return showMsg("å¯†ç¢¼è‡³å°‘è¦ 6 å€‹å­—", "error");
            const btn = document.getElementById('regBtn');
            btn.disabled = true; btn.innerText = "è¨»å†Šä¸­...";
            auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => {
                return db.collection("users").doc(userCredential.user.uid).set({
                    name: name, email: email, status: "pending", createdAt: new Date()
                });
            }).then(() => {
                showMsg("è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…æ ¸å‡†ã€‚", "success");
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                auth.signOut(); setTimeout(() => switchMode('login'), 3000);
            }).catch((error) => {
                btn.disabled = false; btn.innerText = "æäº¤è¨»å†Šç”³è«‹";
                showMsg("è¨»å†Šå¤±æ•—: " + error.message, "error");
            });
        }
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            if(!email || !pass) return showMsg("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼", "error");
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­...";
            auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                showMsg("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤", "error");
            });
        }
        function checkUserStatus(user) {
            db.collection("users").doc(user.uid).get().then((doc) => {
                document.getElementById('loading-mask').style.display = 'none';
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.status === 'approved') {
                        enterSite(userData.name);
                    } else {
                        auth.signOut();
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('loginBtn').innerText = "ç™»å…¥ç³»çµ±";
                        showMsg("æ‚¨çš„å¸³è™Ÿå°šåœ¨å¯©æ ¸ä¸­ã€‚", "error");
                    }
                } else { showMsg("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™", "error"); }
            }).catch((error) => { document.getElementById('loading-mask').style.display = 'none'; showMsg("è®€å–è³‡æ–™å¤±æ•—", "error"); });
        }
        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                auth.signOut().then(() => location.reload());
            }
        }

        // --- ğŸŸ¢ æ ¸å¿ƒï¼šå¾é›²ç«¯è®€å–æª”æ¡ˆçµæ§‹ (åŒ…å«æœ€æ„›èˆ‡ç¯©é¸é‚è¼¯) ---
        let pathStack = [];
        let allFilesFlat = [];
        let cloudItems = []; 
        let userFavorites = []; // å„²å­˜ä½¿ç”¨è€…çš„æœ€æ„›é€£çµ
        let isViewFavoritesMode = false; // æ˜¯å¦æ­£åœ¨çœ‹æœ€æ„›æ¨¡å¼

        // ğŸŸ¢ ä¿®æ”¹å¾Œçš„ enterSite (åŠ å…¥è®€å–æœ€æ„›)
        function enterSite(userName) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${getGreeting()}ï¼Œ${userName}`;
            
            // è®€å–ä½¿ç”¨è€…çš„æœ€æ„›æ¸…å–®
            const uid = auth.currentUser.uid;
            db.collection("users").doc(uid).get().then((doc) => {
                if(doc.exists && doc.data().favorites) {
                    userFavorites = doc.data().favorites;
                } else {
                    userFavorites = [];
                }
                initSite(); 
                listenForAnnouncements(); 
            });
        }

        function initSite() {
            document.title = CONFIG.pageTitle;
            document.getElementById("page-title").innerText = CONFIG.pageTitle;
            
            db.collection('system').doc('files').onSnapshot(doc => {
                if (doc.exists && doc.data().items) {
                    cloudItems = doc.data().items;
                    allFilesFlat = flattenItems(cloudItems);
                    
                    // å¦‚æœç›®å‰åœ¨æœå°‹æ¨¡å¼ï¼Œé‡æ–°æœå°‹ï¼›å¦å‰‡é‡æ–°æ•´ç†ç•¶å‰ç•«é¢
                    if(document.querySelector('.nav-bar').classList.contains('hidden') && !isViewFavoritesMode) {
                        handleSearch();
                    } else {
                        refreshCurrentView();
                    }
                } else {
                    cloudItems = [];
                    renderList([]);
                }
            });
        }

        // ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ·æ–°ç•«é¢ (åŒ…å«æ’åºèˆ‡ç¯©é¸é‚è¼¯)
        function refreshCurrentView() {
            let itemsToRender = [];

            // 1. æ±ºå®šè³‡æ–™ä¾†æº
            if (isViewFavoritesMode) {
                // å¦‚æœåœ¨ã€Œæˆ‘çš„æœ€æ„›ã€æ¨¡å¼ï¼Œå¾æ‰€æœ‰æª”æ¡ˆä¸­ç¯©é¸å‡ºæœ‰æ”¶è—çš„
                itemsToRender = allFilesFlat.filter(item => userFavorites.includes(item.path));
                document.getElementById("breadcrumb-container").innerHTML = `<span class="breadcrumb-current">â­ æˆ‘çš„æœ€æ„›</span>`;
                document.getElementById("backBtn").classList.remove("hidden");
                document.getElementById("backBtn").onclick = exitFavoritesView;
            } else if (document.querySelector('.nav-bar').classList.contains('hidden')) {
                // æœå°‹æ¨¡å¼ä¸‹ï¼Œé€™è£¡é€šå¸¸ä¸è¢«å‘¼å«ï¼Œå› ç‚º handleSearch è‡ªå·±è™•ç†äº†æ¸²æŸ“
                return; 
            } else {
                // ä¸€èˆ¬è³‡æ–™å¤¾æ¨¡å¼
                if (pathStack.length === 0) {
                    itemsToRender = cloudItems;
                } else {
                    itemsToRender = pathStack[pathStack.length - 1].children || [];
                }
                updateBreadcrumb();
            }

            // 2. åŸ·è¡Œç¯©é¸ (Filter)
            const filterType = document.getElementById('filterSelect').value;
            if (filterType !== 'all') {
                itemsToRender = itemsToRender.filter(item => {
                    if (item.type === 'folder') return true; // è³‡æ–™å¤¾åœ¨ä¸€èˆ¬æ¨¡å¼ä¸‹æ°¸é é¡¯ç¤ºï¼Œæœ€æ„›æ¨¡å¼ä¸‹é€šå¸¸æ²’æœ‰è³‡æ–™å¤¾
                    
                    let fileType = getFileType(item);
                    if (filterType === 'doc') return ['doc', 'pdf', 'ppt'].includes(fileType);
                    if (filterType === 'video') return fileType === 'video';
                    if (filterType === 'img') return fileType === 'img';
                    return true;
                });
            }

            // 3. åŸ·è¡Œæ’åº (Sort) - è³‡æ–™å¤¾æ°¸é åœ¨ä¸Šé¢
            const sortType = document.getElementById('sortSelect').value;
            // è¤‡è£½ä¸€ä»½é™£åˆ—ä»¥å…æ”¹åˆ°åŸå§‹è³‡æ–™
            itemsToRender = [...itemsToRender].sort((a, b) => {
                // è³‡æ–™å¤¾æ¬Šé‡æœ€é«˜
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;

                // åŒé¡å‹æ¯”è¼ƒ
                if (sortType === 'name_asc') return a.name.localeCompare(b.name, "zh-Hant");
                if (sortType === 'name_desc') return b.name.localeCompare(a.name, "zh-Hant");
                if (sortType === 'type') {
                    // ç°¡å–®ç”¨é¡å‹å­—ä¸²æ’åº
                    return (a.type || '').localeCompare(b.type || '');
                }
                return 0;
            });

            // 4. æ¸²æŸ“
            renderList(itemsToRender);
        }

        // è¼”åŠ©ï¼šå–å¾—æª”æ¡ˆé¡å‹å­—ä¸²
        function getFileType(item) {
            if (item.icon === 'ğŸ¥' || (item.path && item.path.includes('youtu'))) return 'video';
            if (item.icon === 'ğŸ–¼ï¸' || (item.path && item.path.match(/\.(jpg|png|jpeg)$/i))) return 'img';
            if (item.path && item.path.match(/\.pdf$/i)) return 'pdf';
            if (item.path && item.path.match(/\.ppt(x)?$/i)) return 'ppt';
            return 'doc';
        }

        function flattenItems(items) {
            let result = [];
            items.forEach(item => {
                if(item.type === 'file') { result.push(item); } 
                else if(item.type === 'folder' && item.children) { result = result.concat(flattenItems(item.children)); }
            });
            return result;
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const navBar = document.querySelector('.nav-bar');
            const toolbar = document.getElementById('toolbar'); 

            if (query.length > 0) {
                navBar.classList.add('hidden');
                toolbar.classList.add('hidden'); // æœå°‹æ™‚éš±è—å·¥å…·åˆ—
                isViewFavoritesMode = false; // æœå°‹æ™‚é€€å‡ºæœ€æ„›æ¨¡å¼
                
                const matchedFiles = allFilesFlat.filter(item => 
                    item.name.toLowerCase().includes(query) || (item.note && item.note.toLowerCase().includes(query))
                );
                renderSearchList(matchedFiles, query); // å‘¼å«åŸæœ¬çš„ highlight æ¸²æŸ“
            } else {
                navBar.classList.remove('hidden');
                toolbar.classList.remove('hidden');
                refreshCurrentView();
            }
        }

        function renderSearchList(items, query) {
            const container = document.getElementById("list-root");
            container.innerHTML = "";
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sub);">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„æª”æ¡ˆ</div>';
                return;
            }
            items.forEach(item => {
                const highlightedName = item.name.replace(new RegExp(query, "gi"), (match) => `<span class="highlight">${match}</span>`);
                renderFileItem(container, item, highlightedName);
            });
        }

        // ğŸŸ¢ æ¸²æŸ“åˆ—è¡¨ (åŒ…å«æ˜Ÿæ˜Ÿé‚è¼¯)
        function renderList(items) {
            const container = document.getElementById("list-root");
            container.innerHTML = ""; 
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sub);">(æ­¤åˆ—è¡¨æ˜¯ç©ºçš„)</div>';
                return;
            }
            items.forEach(item => {
                if (item.type === 'folder') {
                    const div = document.createElement("div");
                    div.className = "list-item folder-item";
                    div.innerHTML = `<div class="item-icon">ğŸ“</div><div class="item-info"><div class="item-name">${item.name}</div><div class="item-note">${item.children ? item.children.length + ' å€‹é …ç›®' : 'ç©ºè³‡æ–™å¤¾'}</div></div><div class="item-arrow">â¤</div>`;
                    div.onclick = () => enterFolder(item);
                    container.appendChild(div);
                } else {
                    renderFileItem(container, item, item.name);
                }
            });
        }

        function renderFileItem(container, item, displayName) {
            const div = document.createElement("div");
            let icon = item.icon || 'ğŸ“„';
            let fileType = getFileType(item);
            
            // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
            const isFav = userFavorites.includes(item.path);
            const starClass = isFav ? 'active' : '';

            div.className = "list-item file-item";
            
            // æ³¨æ„ï¼šé€™è£¡åŠ å…¥äº† star-icon çš„ span
            div.innerHTML = `
                <span class="star-icon ${starClass}" onclick="toggleFavorite(event, '${item.path}')">â˜…</span>
                <div class="item-icon" data-type="${fileType}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${displayName}</div>
                    <div class="item-note">${item.note || ''}</div>
                </div>`;
            
            // é»æ“Šé …ç›®æ‰“é–‹æª”æ¡ˆ (é¿å…é»åˆ°æ˜Ÿæ˜Ÿæ™‚ä¹Ÿè§¸ç™¼)
            div.onclick = (e) => {
                if(!e.target.classList.contains('star-icon')) {
                    window.open(item.path, '_blank');
                }
            };
            container.appendChild(div);
        }

        // ğŸŸ¢ æˆ‘çš„æœ€æ„›ç›¸é—œåŠŸèƒ½
        
        // 1. åˆ‡æ›æ”¶è—ç‹€æ…‹
        function toggleFavorite(e, path) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…æ‰“é–‹æª”æ¡ˆ
            const uid = auth.currentUser.uid;
            
            if (userFavorites.includes(path)) {
                // ç§»é™¤
                userFavorites = userFavorites.filter(p => p !== path);
            } else {
                // åŠ å…¥
                userFavorites.push(path);
            }

            // æ›´æ–° UI (é¿å…æ•´é é‡æ•´ï¼Œåªåˆ‡æ› class)
            if (e.target.classList.contains('active')) {
                e.target.classList.remove('active');
            } else {
                e.target.classList.add('active');
            }

            // å¦‚æœç›®å‰æ­£åœ¨çœ‹ã€Œæˆ‘çš„æœ€æ„›ã€ï¼Œç§»é™¤å¾Œæ‡‰è©²è¦æ¶ˆå¤±
            if (isViewFavoritesMode) {
                refreshCurrentView();
            }

            // å¯«å…¥ Firestore
            db.collection("users").doc(uid).update({
                favorites: userFavorites
            }).catch(err => {
                console.error("æ›´æ–°æœ€æ„›å¤±æ•—", err);
                // å¦‚æœç¬¬ä¸€æ¬¡æ²’æœ‰ favorites æ¬„ä½ï¼Œç”¨ set merge
                db.collection("users").doc(uid).set({ favorites: userFavorites }, { merge: true });
            });
        }

        // 2. é€²å…¥ã€Œæˆ‘çš„æœ€æ„›ã€æ¨¡å¼
        function toggleFavoritesView() {
            isViewFavoritesMode = true;
            document.getElementById('searchInput').value = ''; // æ¸…ç©ºæœå°‹
            document.querySelector('.nav-bar').classList.remove('hidden'); // ç¢ºä¿å°èˆªåˆ—é¡¯ç¤º
            refreshCurrentView();
        }

        // 3. é€€å‡ºã€Œæˆ‘çš„æœ€æ„›ã€æ¨¡å¼ (å›åˆ°é¦–é )
        function exitFavoritesView() {
            isViewFavoritesMode = false;
            pathStack = []; // å›åˆ°æ ¹ç›®éŒ„
            document.getElementById("backBtn").onclick = goUp; // æ¢å¾©åŸæœ¬çš„è¿”å›åŠŸèƒ½
            refreshCurrentView();
        }

        // --- å°èˆªåŠŸèƒ½ ---
        function enterFolder(folderItem) { 
            isViewFavoritesMode = false; // é€²å…¥è³‡æ–™å¤¾å°±é›¢é–‹æœ€æ„›æ¨¡å¼
            pathStack.push(folderItem); 
            refreshCurrentView(); 
        }

        function goUp() { 
            if (pathStack.length > 0) { 
                pathStack.pop(); 
                refreshCurrentView(); 
            } 
        }

        function jumpTo(index) { 
            isViewFavoritesMode = false;
            if (index === -1) { 
                pathStack = []; 
            } else { 
                pathStack = pathStack.slice(0, index + 1); 
            } 
            refreshCurrentView(); 
        }

        function updateBreadcrumb() {
            const backBtn = document.getElementById("backBtn");
            // åªæœ‰åœ¨æ ¹ç›®éŒ„ä¸”ä¸æ˜¯æœ€æ„›æ¨¡å¼æ™‚éš±è—è¿”å›éµ
            if (pathStack.length > 0) {
                backBtn.classList.remove("hidden");
                backBtn.onclick = goUp; 
            } else {
                backBtn.classList.add("hidden");
            }
            
            let html = `<span class="breadcrumb-item" onclick="jumpTo(-1)">é¦–é </span>`;
            pathStack.forEach((folder, index) => {
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === pathStack.length - 1) {
                    html += `<span class="breadcrumb-current">${folder.name}</span>`;
                } else {
                    html += `<span class="breadcrumb-item" onclick="jumpTo(${index})">${folder.name}</span>`;
                }
            });
            document.getElementById("breadcrumb-container").innerHTML = html;
        }
    </script>
</body>
</html>
